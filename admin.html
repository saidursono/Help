<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel тАФ рж╕ржорж╛ржЬ ржХрж▓рзНржпрж╛ржг ржпрзБржм рж╕ржВржЧржаржи</title>
<link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --g1:#061a06;--g2:#0d2e0d;--g3:#1b6b1b;--g4:#2e8b2e;--g5:#43a843;
  --gold:#f0b429;--sgold:#ffd966;--dgold:#c8940a;
  --glass:rgba(255,255,255,0.07);--glass2:rgba(255,255,255,0.12);
  --b1:rgba(255,255,255,0.15);--b2:rgba(240,180,41,0.35);
  --blur:blur(18px);--text:#e8f5e8;--text2:#a5d6a7;
  --sidebar:260px;
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Hind Siliguri',sans-serif;background:var(--g1);color:var(--text);min-height:100vh;display:flex;}
body::before{content:'';position:fixed;inset:0;z-index:0;pointer-events:none;
  background:radial-gradient(ellipse 60% 50% at 20% 30%,rgba(46,139,46,.18),transparent 65%);}

/* тХРтХРтХР SIDEBAR тХРтХРтХР */
.sidebar{width:var(--sidebar);background:rgba(6,26,6,.92);backdrop-filter:var(--blur);border-right:1px solid var(--b2);position:fixed;top:0;left:0;bottom:0;z-index:100;display:flex;flex-direction:column;transition:transform .3s;}
.sidebar-logo{padding:22px 20px 16px;border-bottom:1px solid rgba(240,180,41,.15);display:flex;align-items:center;gap:12px;}
.sidebar-logo img{width:44px;height:44px;border-radius:50%;border:2px solid var(--gold);}
.sidebar-logo-txt .title{color:var(--sgold);font-size:11px;font-weight:700;line-height:1.3;}
.sidebar-logo-txt .sub{color:var(--text2);font-size:10px;}
.sidebar-badge{display:inline-block;margin-top:4px;padding:2px 8px;border-radius:8px;font-size:10px;font-weight:700;background:linear-gradient(135deg,var(--gold),var(--sgold));color:var(--g1);}

.sidebar-nav{flex:1;overflow-y:auto;padding:14px 10px;}
.nav-section{color:rgba(255,255,255,.25);font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;padding:14px 10px 6px;}
.nav-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;cursor:pointer;color:rgba(255,255,255,.65);font-size:13px;font-weight:500;transition:all .22s;border:1px solid transparent;margin-bottom:2px;}
.nav-item:hover{background:var(--glass2);color:#fff;}
.nav-item.active{background:rgba(240,180,41,.15);color:var(--sgold);border-color:var(--b2);}
.nav-item .ico{font-size:1rem;width:20px;text-align:center;}
.nav-item .badge{margin-left:auto;background:rgba(244,67,54,.8);color:#fff;border-radius:10px;padding:1px 7px;font-size:11px;font-weight:700;}

.sidebar-footer{padding:16px;border-top:1px solid rgba(255,255,255,.06);}
.user-info{display:flex;align-items:center;gap:10px;margin-bottom:10px;}
.user-av{width:36px;height:36px;border-radius:50%;background:var(--g3);border:1.5px solid var(--gold);object-fit:cover;overflow:hidden;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;}
.user-name{color:var(--sgold);font-size:13px;font-weight:600;}
.user-role{color:rgba(255,255,255,.4);font-size:11px;}
.logout-btn{width:100%;padding:8px;border:1px solid rgba(244,67,54,.3);background:rgba(244,67,54,.08);color:#ff6b6b;border-radius:8px;cursor:pointer;font-size:13px;font-family:inherit;transition:all .2s;}
.logout-btn:hover{background:rgba(244,67,54,.18);}

/* тХРтХРтХР MAIN тХРтХРтХР */
.main{margin-left:var(--sidebar);flex:1;display:flex;flex-direction:column;min-height:100vh;position:relative;z-index:1;}
.topbar{padding:16px 28px;background:rgba(6,26,6,.7);backdrop-filter:var(--blur);border-bottom:1px solid rgba(255,255,255,.06);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50;}
.topbar h2{color:var(--sgold);font-size:1.1rem;font-weight:700;}
.topbar-right{display:flex;gap:10px;align-items:center;}
.ham-btn{display:none;background:none;border:none;color:var(--sgold);font-size:1.4rem;cursor:pointer;}

.content{padding:24px 28px;flex:1;}

/* тХРтХРтХР CARDS тХРтХРтХР */
.stat-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:16px;margin-bottom:28px;}
.stat-card{padding:22px 20px;border-radius:16px;background:var(--glass);backdrop-filter:var(--blur);border:1px solid var(--b1);position:relative;overflow:hidden;}
.stat-card::before{content:'';position:absolute;top:-20px;right:-20px;width:80px;height:80px;border-radius:50%;opacity:.12;}
.stat-card.gold::before{background:var(--gold);}
.stat-card.green::before{background:var(--g4);}
.stat-card.red::before{background:#f44336;}
.stat-card.blue::before{background:#2196f3;}
.stat-num{font-size:2.2rem;font-weight:700;color:var(--sgold);}
.stat-label{color:var(--text2);font-size:13px;margin-top:4px;}
.stat-ico{position:absolute;top:18px;right:18px;font-size:1.8rem;opacity:.6;}

/* тХРтХРтХР TABLE тХРтХРтХР */
.table-wrap{background:var(--glass);backdrop-filter:var(--blur);border:1px solid var(--b1);border-radius:16px;overflow:hidden;}
.table-head{padding:18px 22px;border-bottom:1px solid rgba(255,255,255,.06);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;}
.table-head h3{color:var(--sgold);font-size:1rem;font-weight:700;}
.search-inp{padding:9px 16px;background:var(--glass2);border:1px solid var(--b1);border-radius:8px;color:#fff;font-size:13px;font-family:inherit;outline:none;width:220px;}
.search-inp:focus{border-color:var(--b2);}
.search-inp::placeholder{color:rgba(255,255,255,.3);}

table{width:100%;border-collapse:collapse;}
th{padding:13px 16px;text-align:left;color:rgba(255,255,255,.4);font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid rgba(255,255,255,.06);}
td{padding:12px 16px;border-bottom:1px solid rgba(255,255,255,.04);font-size:13px;color:rgba(255,255,255,.8);}
tr:last-child td{border-bottom:none;}
tr:hover td{background:rgba(255,255,255,.03);}

.mem-av{width:38px;height:38px;border-radius:50%;border:1.5px solid var(--gold);object-fit:cover;background:var(--g3);display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;overflow:hidden;flex-shrink:0;}
.mem-info{display:flex;align-items:center;gap:10px;}
.mem-name{color:var(--sgold);font-weight:600;}
.mem-sub{color:rgba(255,255,255,.4);font-size:11px;}

/* BADGES */
.badge{display:inline-block;padding:3px 10px;border-radius:8px;font-size:11px;font-weight:600;}
.b-pending{background:rgba(255,193,7,.15);border:1px solid rgba(255,193,7,.3);color:#ffd54f;}
.b-approved{background:rgba(76,175,80,.15);border:1px solid rgba(76,175,80,.3);color:#81c784;}
.b-rejected{background:rgba(244,67,54,.15);border:1px solid rgba(244,67,54,.3);color:#ef9a9a;}
.b-admin{background:rgba(240,180,41,.15);border:1px solid rgba(240,180,41,.3);color:var(--sgold);}
.b-superadmin{background:linear-gradient(135deg,rgba(255,215,0,.2),rgba(255,215,0,.08));border:1px solid rgba(255,215,0,.4);color:#ffd700;}

/* BUTTONS */
.btn{padding:7px 14px;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;border:none;font-family:inherit;transition:all .2s;}
.btn-g{background:linear-gradient(135deg,var(--gold),var(--sgold));color:var(--g1);}
.btn-g:hover{transform:translateY(-1px);}
.btn-r{background:rgba(244,67,54,.15);border:1px solid rgba(244,67,54,.3);color:#ff6b6b;}
.btn-r:hover{background:rgba(244,67,54,.25);}
.btn-b{background:rgba(33,150,243,.15);border:1px solid rgba(33,150,243,.3);color:#64b5f6;}
.btn-b:hover{background:rgba(33,150,243,.25);}
.btn-lg{padding:10px 20px;font-size:13px;}

/* TABS */
.page-tabs{display:flex;gap:6px;margin-bottom:20px;flex-wrap:wrap;}
.ptab{padding:8px 18px;border-radius:10px;cursor:pointer;font-size:13px;font-weight:600;border:1px solid var(--b1);background:var(--glass);color:var(--text2);font-family:inherit;transition:all .2s;}
.ptab.active,.ptab:hover{background:rgba(240,180,41,.15);border-color:var(--b2);color:var(--sgold);}

/* FORM IN PANEL */
.form-panel{background:var(--glass);border:1px solid var(--b1);border-radius:16px;padding:24px;margin-bottom:20px;}
.form-panel h4{color:var(--sgold);font-size:1rem;font-weight:700;margin-bottom:16px;padding-bottom:10px;border-bottom:1px solid rgba(255,255,255,.06);}
.fg{margin-bottom:14px;}
.fg label{display:block;margin-bottom:5px;color:rgba(255,255,255,.7);font-size:13px;font-weight:500;}
.fg input,.fg select,.fg textarea{width:100%;padding:10px 14px;background:var(--glass2);border:1px solid var(--b1);border-radius:8px;color:#fff;font-size:13px;font-family:inherit;outline:none;transition:border .2s;}
.fg input:focus,.fg select:focus,.fg textarea:focus{border-color:var(--b2);}
.fg select option{background:#0d2e0d;}
.fg textarea{height:90px;resize:vertical;}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
.grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;}

/* ALERT */
.flash{padding:10px 14px;border-radius:8px;font-size:13px;margin-bottom:14px;display:none;}
.flash.show{display:block;}
.flash-ok{background:rgba(76,175,80,.15);border:1px solid rgba(76,175,80,.3);color:#81c784;}
.flash-err{background:rgba(244,67,54,.15);border:1px solid rgba(244,67,54,.3);color:#ff6b6b;}

/* NOTICE CARD */
.notice-row{display:flex;gap:14px;align-items:flex-start;padding:16px;border-bottom:1px solid rgba(255,255,255,.04);}
.notice-row:last-child{border-bottom:none;}
.notice-type-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;margin-top:5px;}
.notice-content{flex:1;}
.notice-title{color:var(--sgold);font-weight:600;font-size:.9rem;margin-bottom:4px;}
.notice-body{color:rgba(255,255,255,.6);font-size:12px;line-height:1.7;}
.notice-meta{color:rgba(255,255,255,.3);font-size:11px;margin-top:6px;}

/* IMG PREVIEW */
.img-preview-wrap{margin-top:8px;}
.img-preview{width:80px;height:80px;object-fit:cover;border-radius:8px;border:1px solid var(--b1);}

/* EMPTY STATE */
.empty{text-align:center;padding:40px;color:rgba(255,255,255,.3);}
.empty-ico{font-size:3rem;margin-bottom:10px;}

/* MOBILE */
@media(max-width:768px){
  .sidebar{transform:translateX(-100%);}
  .sidebar.open{transform:translateX(0);}
  .main{margin-left:0;}
  .ham-btn{display:block;}
  .content{padding:16px;}
  .grid2,.grid3{grid-template-columns:1fr;}
  .stat-grid{grid-template-columns:1fr 1fr;}
  table{font-size:12px;}
  th,td{padding:10px 10px;}
}

/* OVERLAY for mobile sidebar */
.sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:99;}
.sidebar-overlay.open{display:block;}

/* SCROLL */
.sidebar-nav::-webkit-scrollbar,.content::-webkit-scrollbar{width:4px;}
.sidebar-nav::-webkit-scrollbar-thumb,.content::-webkit-scrollbar-thumb{background:rgba(240,180,41,.2);border-radius:2px;}
</style>
</head>
<body>

<!-- Mobile sidebar overlay -->
<div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

<!-- тХРтХРтХР SIDEBAR тХРтХРтХР -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-logo">
    <img src="https://i.ibb.co.com/XZF23TDY/received-895949380028820.jpg" alt="Logo">
    <div class="sidebar-logo-txt">
      <div class="title">рж╕ржорж╛ржЬ ржХрж▓рзНржпрж╛ржг ржпрзБржм рж╕ржВржЧржаржи</div>
      <div class="sub">Admin Panel</div>
      <div class="sidebar-badge" id="adminBadge">тнР Super Admin</div>
    </div>
  </div>

  <nav class="sidebar-nav">
    <div class="nav-section">ржкрзНрж░ржзрж╛ржи</div>
    <div class="nav-item active" onclick="goSection('dashboard')"><span class="ico">ЁЯУК</span> ржбрзНржпрж╛рж╢ржмрзЛрж░рзНржб</div>

    <div class="nav-section">рж╕ржжрж╕рзНржп ржмрзНржпржмрж╕рзНржерж╛ржкржирж╛</div>
    <div class="nav-item" onclick="goSection('pending')"><span class="ico">тП│</span> ржкрзЗржирзНржбрж┐ржВ ржЖржмрзЗржжржи <span class="badge" id="pendingBadge">0</span></div>
    <div class="nav-item" onclick="goSection('members')"><span class="ico">ЁЯСе</span> рж╕ржХрж▓ рж╕ржжрж╕рзНржп</div>
    <div class="nav-item" onclick="goSection('addmember')"><span class="ico">тЮХ</span> рж╕ржжрж╕рзНржп ржпрзЛржЧ ржХрж░рзБржи</div>
    <div class="nav-item" onclick="goSection('admins')" id="nav-admins"><span class="ico">ЁЯФС</span> Admin ржмрзНржпржмрж╕рзНржерж╛ржкржирж╛</div>

    <div class="nav-section">ржХржирзНржЯрзЗржирзНржЯ</div>
    <div class="nav-item" onclick="goSection('notices')"><span class="ico">ЁЯУв</span> ржирзЛржЯрж┐рж╢</div>
    <div class="nav-item" onclick="goSection('gallery')"><span class="ico">ЁЯУ╖</span> ржЧрзНржпрж╛рж▓рж╛рж░рж┐</div>
    <div class="nav-item" onclick="goSection('stats')"><span class="ico">ЁЯУИ</span> ржкрж░рж┐рж╕ржВржЦрзНржпрж╛ржи</div>

    <div class="nav-section">ржЕрж░рзНрже ржмрзНржпржмрж╕рзНржерж╛ржкржирж╛</div>
    <div class="nav-item" onclick="goSection('payments')"><span class="ico">ЁЯТ░</span> ржЪрж╛ржБржжрж╛ / ржкрзЗржорзЗржирзНржЯ</div>

    <div class="nav-section">ржЕржирзНржпрж╛ржирзНржп</div>
    <div class="nav-item" onclick="goSection('reports')"><span class="ico">ЁЯУе</span> рж░рж┐ржкрзЛрж░рзНржЯ ржбрж╛ржЙржирж▓рзЛржб</div>
    <div class="nav-item" onclick="window.open('index.html','_blank')"><span class="ico">ЁЯМР</span> ржорзВрж▓ рж╕рж╛ржЗржЯ ржжрзЗржЦрзБржи</div>
  </nav>

  <div class="sidebar-footer">
    <div class="user-info">
      <div class="user-av" id="sidebarAv">S</div>
      <div>
        <div class="user-name" id="sidebarName">рж▓рзЛржб рж╣ржЪрзНржЫрзЗ...</div>
        <div class="user-role" id="sidebarRole">Admin</div>
      </div>
    </div>
    <button class="logout-btn" onclick="doLogout()">ЁЯЪк рж▓ржЧржЖржЙржЯ</button>
  </div>
</div>

<!-- тХРтХРтХР MAIN тХРтХРтХР -->
<div class="main">
  <div class="topbar">
    <div style="display:flex;align-items:center;gap:14px;">
      <button class="ham-btn" onclick="openSidebar()">тШ░</button>
      <h2 id="sectionTitle">ЁЯУК ржбрзНржпрж╛рж╢ржмрзЛрж░рзНржб</h2>
    </div>
    <div class="topbar-right">
      <span style="color:rgba(255,255,255,.4);font-size:12px;" id="currentTime"></span>
    </div>
  </div>

  <div class="content">

    <!-- тХРтХР DASHBOARD тХРтХР -->
    <div id="s-dashboard">
      <div class="stat-grid">
        <div class="stat-card gold"><div class="stat-ico">ЁЯСе</div><div class="stat-num" id="d-total">-</div><div class="stat-label">ржорзЛржЯ рж╕ржжрж╕рзНржп</div></div>
        <div class="stat-card green"><div class="stat-ico">тЬЕ</div><div class="stat-num" id="d-approved">-</div><div class="stat-label">ржЕржирзБржорзЛржжрж┐ржд</div></div>
        <div class="stat-card red"><div class="stat-ico">тП│</div><div class="stat-num" id="d-pending">-</div><div class="stat-label">ржкрзЗржирзНржбрж┐ржВ ржЖржмрзЗржжржи</div></div>
        <div class="stat-card blue"><div class="stat-ico">ЁЯУв</div><div class="stat-num" id="d-notices">-</div><div class="stat-label">ржирзЛржЯрж┐рж╢</div></div>
        <div class="stat-card" style="border-color:rgba(240,180,41,.3)"><div class="stat-ico">ЁЯТ░</div><div class="stat-num" id="d-payments" style="font-size:1.6rem">рз│-</div><div class="stat-label">ржорзЛржЯ ржЪрж╛ржБржжрж╛ рж╕ржВржЧрзНрж░рж╣</div></div>
      </div>

      <!-- Recent pending -->
      <div class="table-wrap">
        <div class="table-head"><h3>тП│ рж╕рж╛ржорзНржкрзНрж░рждрж┐ржХ ржкрзЗржирзНржбрж┐ржВ ржЖржмрзЗржжржи</h3>
          <button class="btn btn-g" onclick="goSection('pending')">рж╕ржм ржжрзЗржЦрзБржи тЖТ</button></div>
        <div id="dashPendingList"><div class="empty"><div class="empty-ico">тЬЕ</div>ржХрзЛржирзЛ ржкрзЗржирзНржбрж┐ржВ ржЖржмрзЗржжржи ржирзЗржЗ</div></div>
      </div>
    </div>

    <!-- тХРтХР PENDING REQUESTS тХРтХР -->
    <div id="s-pending" style="display:none">
      <div class="flash flash-ok" id="pFlash"></div>
      <div class="table-wrap">
        <div class="table-head">
          <h3>тП│ ржкрзЗржирзНржбрж┐ржВ ржЖржмрзЗржжржи рж╕ржорзВрж╣</h3>
          <input class="search-inp" placeholder="ЁЯФН ржирж╛ржо ржмрж╛ ржПрж▓рж╛ржХрж╛..." oninput="searchPending(this.value)">
        </div>
        <div id="pendingList"></div>
      </div>
    </div>

    <!-- тХРтХР ALL MEMBERS тХРтХР -->
    <div id="s-members" style="display:none">
      <div class="flash flash-ok" id="mFlash"></div>
      <div class="table-wrap">
        <div class="table-head">
          <h3>ЁЯСе рж╕ржХрж▓ рж╕ржжрж╕рзНржп</h3>
          <input class="search-inp" placeholder="ЁЯФН ржирж╛ржо, ржПрж▓рж╛ржХрж╛, ржлрзЛржи..." oninput="searchMembers(this.value)">
        </div>
        <div style="overflow-x:auto">
        <table>
          <thead><tr>
            <th>рж╕ржжрж╕рзНржп</th><th>ID</th><th>ржПрж▓рж╛ржХрж╛</th><th>ржлрзЛржи</th><th>ржкржжржмрж┐</th><th>рж░ржХрзНржд</th><th>ржЕржмрж╕рзНржерж╛</th><th>ржХрж╛рж░рзНржпржХрзНрж░ржо</th>
          </tr></thead>
          <tbody id="memberTableBody"></tbody>
        </table>
        </div>
      </div>
    </div>


    <!-- тХРтХР ADD MEMBER (ADMIN) тХРтХР -->
    <div id="s-addmember" style="display:none">
      <div class="flash flash-ok" id="amFlash"></div>
      <div class="form-panel">
        <h4>тЮХ ржирждрзБржи рж╕ржжрж╕рзНржп ржпрзЛржЧ ржХрж░рзБржи</h4>
        <p style="color:rgba(255,255,255,.4);font-size:13px;margin-bottom:18px;">ржПржЦрж╛ржирзЗ рж╕рж░рж╛рж╕рж░рж┐ рж╕ржжрж╕рзНржп ржпрзЛржЧ ржХрж░рж╛ рж╣ржмрзЗ тАФ Firebase account ржЫрж╛ржбрж╝рж╛ржЗ approved рж╣рж┐рж╕рзЗржмрзЗред</p>

        <!-- ржЫржмрж┐ ржЖржкрж▓рзЛржб -->
        <div class="fg">
          <label>ЁЯУ╕ рж╕ржжрж╕рзНржпрзЗрж░ ржЫржмрж┐ <span style="color:var(--gold)">*</span></label>
          <div id="amPhotoBox" onclick="document.getElementById('amPhotoFile').click()" style="border:2px dashed rgba(240,180,41,.35);border-radius:12px;padding:20px;text-align:center;cursor:pointer;transition:all .3s;position:relative;overflow:hidden;" onmouseover="this.style.borderColor='var(--gold)'" onmouseout="this.style.borderColor='rgba(240,180,41,.35)'">
            <input type="file" id="amPhotoFile" accept="image/*" style="display:none" onchange="amPreviewPhoto(this)">
            <div id="amPhotoPlaceholder">
              <div style="font-size:2.5rem;margin-bottom:8px">ЁЯУ╖</div>
              <p style="color:rgba(255,255,255,.5);font-size:13px"><strong style="color:var(--sgold)">ржХрзНрж▓рж┐ржХ ржХрж░рзЗ ржЫржмрж┐ ржмрзЗржЫрзЗ ржирж┐ржи</strong></p>
              <p style="color:rgba(255,255,255,.3);font-size:12px">JPG, PNG тАФ рж╕рж░рзНржмрзЛржЪрзНржЪ 5MB</p>
            </div>
            <img id="amPhotoPreview" src="" style="display:none;width:120px;height:120px;object-fit:cover;border-radius:50%;border:3px solid var(--gold);margin:0 auto;">
          </div>
          <div class="upload-progress" id="amUploadProgress" style="display:none;margin-top:8px">
            <div style="background:rgba(255,255,255,.1);border-radius:4px;height:6px;overflow:hidden;">
              <div id="amUploadBar" style="height:100%;background:linear-gradient(90deg,var(--gold),var(--sgold));border-radius:4px;width:0%;transition:width .3s;"></div>
            </div>
            <span id="amUploadTxt" style="color:var(--text2);font-size:12px;margin-top:4px;display:block"></span>
          </div>
        </div>

        <!-- ржорзВрж▓ рждржерзНржп -->
        <div class="grid2">
          <div class="fg"><label>ЁЯСд ржкрзБрж░рзЛ ржирж╛ржо <span style="color:var(--gold)">*</span></label><input type="text" id="am-name" placeholder="ржпрзЗржоржи: ржорзЛржГ рж░рж╣рж┐ржо"></div>
          <div class="fg"><label>ЁЯУЮ ржорзЛржмрж╛ржЗрж▓ ржиржорзНржмрж░</label><input type="tel" id="am-phone" placeholder="01XXXXXXXXX"></div>
        </div>
        <div class="grid2">
          <div class="fg"><label>ЁЯУН ржЧрзНрж░рж╛ржо/ржПрж▓рж╛ржХрж╛ <span style="color:var(--gold)">*</span></label>
            <select id="am-area">
              <option value="">-- ржЧрзНрж░рж╛ржо ржмрзЗржЫрзЗ ржирж┐ржи --</option>
              <option>ржХрж╛ржирзНржжрж┐рж░ржкрж╛ржбрж╝рж╛</option>
              <option>ржЗржирж╕рж╛ржл ржиржЧрж░</option>
              <option>рж╣рж▓ржжрж╛рж░ ржкрж╛ржбрж╝рж╛</option>
              <option>ржЪрж░ржкрж╛ржбрж╝рж╛</option>
              <option>ржЪрж╛ржЗржбрзБржмрж╛</option>
              <option>ржорзЛрж╣рж╛ржорзНржоржжржкрзБрж░</option>
              <option>ржирж┐ржЪржкрж╛ржбрж╝рж╛</option>
              <option>рж╕рзЛржирж╛рждрж▓рж╛</option>
              <option>ржЕржирзНржпрж╛ржирзНржп</option>
            </select>
          </div>
          <div class="fg"><label>тнР ржкржжржмрж┐</label>
            <select id="am-position">
              <option value="рж╕ржжрж╕рзНржп">рж╕ржжрж╕рзНржп</option>
              <option value="рж╕ржнрж╛ржкрждрж┐">рж╕ржнрж╛ржкрждрж┐</option>
              <option value="рж╕рж╛ржзрж╛рж░ржг рж╕ржорзНржкрж╛ржжржХ">рж╕рж╛ржзрж╛рж░ржг рж╕ржорзНржкрж╛ржжржХ</option>
              <option value="рж╕рж╣-рж╕ржнрж╛ржкрждрж┐">рж╕рж╣-рж╕ржнрж╛ржкрждрж┐</option>
              <option value="ржХрзЛрж╖рж╛ржзрзНржпржХрзНрж╖">ржХрзЛрж╖рж╛ржзрзНржпржХрзНрж╖</option>
              <option value="ржХрж╛рж░рзНржпржирж┐рж░рзНржмрж╛рж╣рзА рж╕ржжрж╕рзНржп">ржХрж╛рж░рзНржпржирж┐рж░рзНржмрж╛рж╣рзА рж╕ржжрж╕рзНржп</option>
              <option value="рж╕рзНржмрзЗржЪрзНржЫрж╛рж╕рзЗржмрзА">рж╕рзНржмрзЗржЪрзНржЫрж╛рж╕рзЗржмрзА</option>
            </select>
          </div>
        </div>
        <div class="grid2">
          <div class="fg"><label>ЁЯй╕ рж░ржХрзНрждрзЗрж░ ржЧрзНрж░рзБржк</label>
            <select id="am-blood">
              <option value="">-- рж░ржХрзНрждрзЗрж░ ржЧрзНрж░рзБржк --</option>
              <option>A+</option><option>A-</option>
              <option>B+</option><option>B-</option>
              <option>AB+</option><option>AB-</option>
              <option>O+</option><option>O-</option>
            </select>
          </div>
          <div class="fg"><label>тЪд рж▓рж┐ржЩрзНржЧ</label>
            <select id="am-gender">
              <option value="">-- рж▓рж┐ржЩрзНржЧ --</option>
              <option value="ржкрзБрж░рзБрж╖">ржкрзБрж░рзБрж╖</option>
              <option value="ржорж╣рж┐рж▓рж╛">ржорж╣рж┐рж▓рж╛</option>
              <option value="ржЕржирзНржпрж╛ржирзНржп">ржЕржирзНржпрж╛ржирзНржп</option>
            </select>
          </div>
        </div>
        <div class="grid2">
          <div class="fg"><label>ЁЯОВ ржЬржирзНржо рждрж╛рж░рж┐ржЦ</label><input type="date" id="am-dob"></div>
          <div class="fg"><label>ЁЯУз ржЗржорзЗржЗрж▓</label><input type="email" id="am-email" placeholder="ржРржЪрзНржЫрж┐ржХ"></div>
        </div>
        <div class="fg"><label>ЁЯПа рж╕ржорзНржкрзВрж░рзНржг ржарж┐ржХрж╛ржирж╛</label><input type="text" id="am-address" placeholder="ржЧрзНрж░рж╛ржо, ржЙржкржЬрзЗрж▓рж╛, ржЬрзЗрж▓рж╛"></div>

        <div style="display:flex;gap:10px;margin-top:6px;flex-wrap:wrap;">
          <button class="btn btn-g btn-lg" id="amSaveBtn" onclick="saveAdminMember()">ЁЯТ╛ рж╕ржжрж╕рзНржп рж╕ржВрж░ржХрзНрж╖ржг ржХрж░рзБржи</button>
          <button class="btn btn-b btn-lg" onclick="resetAmForm()">ЁЯФД ржлрж░рзНржо ржкрж░рж┐рж╖рзНржХрж╛рж░ ржХрж░рзБржи</button>
        </div>
      </div>
    </div>

    <!-- тХРтХР ADMIN MANAGEMENT тХРтХР -->
    <div id="s-admins" style="display:none">
      <div class="flash flash-ok" id="aFlash"></div>
      <div class="form-panel">
        <h4>ЁЯФС ржирждрзБржи Admin ржпрзЛржЧ ржХрж░рзБржи</h4>
        <div class="grid2">
          <div class="fg"><label>рж╕ржжрж╕рзНржп ржирж┐рж░рзНржмрж╛ржЪржи ржХрж░рзБржи</label>
            <select id="adminSelectMember"><option value="">-- рж╕ржжрж╕рзНржп ржмрзЗржЫрзЗ ржирж┐ржи --</option></select>
          </div>
          <div class="fg"><label>Role</label>
            <select id="adminRole">
              <option value="admin">Admin</option>
              <option value="superadmin">Super Admin</option>
            </select>
          </div>
        </div>
        <button class="btn btn-g btn-lg" onclick="makeAdmin()">ЁЯФС Admin ржХрж░рзБржи</button>
      </div>
      <div class="table-wrap">
        <div class="table-head"><h3>ЁЯФС ржмрж░рзНрждржорж╛ржи AdminржЧржг</h3></div>
        <div style="overflow-x:auto">
        <table>
          <thead><tr><th>рж╕ржжрж╕рзНржп</th><th>ржЗржорзЗржЗрж▓</th><th>Role</th><th>ржХрж╛рж░рзНржпржХрзНрж░ржо</th></tr></thead>
          <tbody id="adminTableBody"></tbody>
        </table>
        </div>
      </div>
    </div>

    <!-- тХРтХР NOTICES тХРтХР -->
    <div id="s-notices" style="display:none">
      <div class="flash flash-ok" id="nFlash"></div>
      <div class="page-tabs">
        <button class="ptab active" onclick="switchNoticeTab('list',this)">ЁЯУЛ ржирзЛржЯрж┐рж╢ рждрж╛рж▓рж┐ржХрж╛</button>
        <button class="ptab" onclick="switchNoticeTab('add',this)">тЮХ ржирждрзБржи ржирзЛржЯрж┐рж╢</button>
      </div>

      <!-- Notice List -->
      <div id="noticeListPanel">
        <div class="table-wrap">
          <div class="table-head"><h3>ЁЯУв рж╕ржХрж▓ ржирзЛржЯрж┐рж╢</h3></div>
          <div id="noticeList"></div>
        </div>
      </div>

      <!-- Add Notice -->
      <div id="noticeAddPanel" style="display:none">
        <div class="form-panel">
          <h4 id="noticeFormTitle">тЮХ ржирждрзБржи ржирзЛржЯрж┐рж╢ ржпрзЛржЧ ржХрж░рзБржи</h4>
          <input type="hidden" id="editNoticeId">
          <div class="fg"><label>рж╢рж┐рж░рзЛржирж╛ржо *</label><input type="text" id="n-title" placeholder="ржирзЛржЯрж┐рж╢рзЗрж░ рж╢рж┐рж░рзЛржирж╛ржо"></div>
          <div class="fg"><label>ржмрж┐ржмрж░ржг *</label><textarea id="n-body" placeholder="ржирзЛржЯрж┐рж╢рзЗрж░ ржмрж┐рж╕рзНрждрж╛рж░рж┐ржд..."></textarea></div>
          <div class="fg"><label>ЁЯФЧ рж▓рж┐ржВржХ (ржРржЪрзНржЫрж┐ржХ)</label><input type="url" id="n-link" placeholder="https://example.com (ржирж╛ ржерж╛ржХрж▓рзЗ ржЦрж╛рж▓рж┐ рж░рж╛ржЦрзБржи)"></div>
          <div class="grid3">
            <div class="fg"><label>ржзрж░ржи</label>
              <select id="n-type">
                <option value="default">рж╕рж╛ржзрж╛рж░ржг</option>
                <option value="urgent">ржЬрж░рзБрж░рж┐</option>
                <option value="info">рждржерзНржп</option>
                <option value="success">рж╕ржлрж▓рждрж╛</option>
              </select>
            </div>
            <div class="fg"><label>ржЫржмрж┐ (ржРржЪрзНржЫрж┐ржХ)</label><input type="file" id="n-photo" accept="image/*"></div>
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;">
            <button class="btn btn-g btn-lg" onclick="saveNotice()">ЁЯТ╛ рж╕ржВрж░ржХрзНрж╖ржг ржХрж░рзБржи</button>
            <button class="btn btn-b btn-lg" onclick="switchNoticeTab('list',document.querySelector('.ptab'))">тЖР ржлрж┐рж░рзЗ ржпрж╛ржи</button>
          </div>
        </div>
      </div>
    </div>

    <!-- тХРтХР GALLERY тХРтХР -->
    <div id="s-gallery" style="display:none">
      <div class="flash flash-ok" id="gFlash"></div>
      <div class="page-tabs">
        <button class="ptab active" onclick="switchGalTab('list',this)">ЁЯУ╖ ржЧрзНржпрж╛рж▓рж╛рж░рж┐</button>
        <button class="ptab" onclick="switchGalTab('add',this)">тЮХ ржЫржмрж┐ ржпрзЛржЧ ржХрж░рзБржи</button>
      </div>
      <div id="galListPanel">
        <div id="galAdminGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:14px;"></div>
      </div>
      <div id="galAddPanel" style="display:none">
        <div class="form-panel">
          <h4>ЁЯУ╖ ржирждрзБржи ржЫржмрж┐ ржпрзЛржЧ ржХрж░рзБржи</h4>
          <div class="fg"><label>ржЫржмрж┐ *</label><input type="file" id="g-photo" accept="image/*" onchange="previewGalPhoto(this)"><div id="galPreviewWrap" class="img-preview-wrap"></div></div>
          <div class="fg"><label>ржмрж┐ржмрж░ржг *</label><input type="text" id="g-caption" placeholder="ржЫржмрж┐рж░ ржмрж┐ржмрж░ржг"></div>
          <div class="fg"><label>ржХрзНржпрж╛ржЯрж╛ржЧрж░рж┐</label>
            <select id="g-cat">
              <option value="event">ржЕржирзБрж╖рзНржарж╛ржи</option><option value="tree">ржмрзГржХрзНрж╖рж░рзЛржкржг</option>
              <option value="edu">рж╢рж┐ржХрзНрж╖рж╛</option><option value="blood">рж░ржХрзНрждржжрж╛ржи</option>
              <option value="relief">рж╕рж╣рж╛ржпрж╝рждрж╛</option>
            </select>
          </div>
          <button class="btn btn-g btn-lg" onclick="uploadGalleryPhoto()">ЁЯУд ржЖржкрж▓рзЛржб ржХрж░рзБржи</button>
        </div>
      </div>
    </div>

    <!-- тХРтХР STATS тХРтХР -->
    <div id="s-stats" style="display:none">
      <div class="flash flash-ok" id="stFlash"></div>
      <div class="form-panel">
        <h4>ЁЯУИ ржкрж░рж┐рж╕ржВржЦрзНржпрж╛ржи ржЖржкржбрзЗржЯ ржХрж░рзБржи</h4>
        <div class="grid2">
          <div class="fg"><label>рж╕ржХрзНрж░рж┐ржпрж╝ рж╕ржжрж╕рзНржп</label><input type="number" id="st-members" placeholder="ржпрзЗржоржи: 25"></div>
          <div class="fg"><label>ржЧрзНрж░рж╛ржорзЗрж░ рж╢рж╛ржЦрж╛</label><input type="number" id="st-branches" placeholder="ржпрзЗржоржи: 6"></div>
          <div class="fg"><label>рж╕ржорж╛ржЬ ржХрж╛рж░рзНржпржХрзНрж░ржо</label><input type="number" id="st-activities" placeholder="ржпрзЗржоржи: 50"></div>
          <div class="fg"><label>ржмржЫрж░рзЗрж░ ржЕржнрж┐ржЬрзНржЮрждрж╛</label><input type="number" id="st-years" placeholder="ржпрзЗржоржи: 1"></div>
          <div class="fg"><label>рж╢рж┐ржХрзНрж╖рж╛рж░рзНржерзА рж╕рж╣рж╛ржпрж╝рждрж╛</label><input type="number" id="st-students" placeholder="ржпрзЗржоржи: 15"></div>
          <div class="fg"><label>ржЧрж╛ржЫ рж░рзЛржкржг</label><input type="number" id="st-trees" placeholder="ржпрзЗржоржи: 120"></div>
          <div class="fg"><label>рж░ржХрзНрждржжрж╛ржи ржЗржЙржирж┐ржЯ</label><input type="number" id="st-blood" placeholder="ржпрзЗржоржи: 20"></div>
          <div class="fg"><label>ржкрж░рж┐ржмрж╛рж░ рж╕рж╣рж╛ржпрж╝рждрж╛</label><input type="number" id="st-families" placeholder="ржпрзЗржоржи: 50"></div>
        </div>
        <button class="btn btn-g btn-lg" onclick="saveStats()">ЁЯТ╛ ржЖржкржбрзЗржЯ ржХрж░рзБржи</button>
      </div>
    </div>

    <!-- тХРтХР PAYMENTS тХРтХР -->
    <div id="s-payments" style="display:none">
      <div class="flash flash-ok" id="payFlash"></div>
      <div class="page-tabs">
        <button class="ptab active" onclick="switchPayTab('list',this)">ЁЯТ░ ржЪрж╛ржБржжрж╛рж░ рждрж╛рж▓рж┐ржХрж╛</button>
        <button class="ptab" onclick="switchPayTab('add',this)">тЮХ ржирждрзБржи ржПржирзНржЯрзНрж░рж┐</button>
        <button class="ptab" onclick="switchPayTab('summary',this)">ЁЯУК рж╕рж╛рж░рж╕ржВржХрзНрж╖рзЗржк</button>
      </div>

      <!-- Payment List -->
      <div id="payListPanel">
        <div class="table-wrap">
          <div class="table-head">
            <h3>ЁЯТ░ рж╕ржХрж▓ ржкрзЗржорзЗржирзНржЯ рж░рзЗржХрж░рзНржб</h3>
            <input class="search-inp" placeholder="ЁЯФН ржирж╛ржо ржмрж╛ ржорж╛рж╕..." oninput="searchPayments(this.value)" id="paySearchInp">
          </div>
          <div style="overflow-x:auto">
          <table>
            <thead><tr><th>рж╕ржжрж╕рзНржп</th><th>ржкрж░рж┐ржорж╛ржг (рз│)</th><th>ржорж╛рж╕/ржмржЫрж░</th><th>ржзрж░ржи</th><th>рждрж╛рж░рж┐ржЦ</th><th>ржирзЛржЯ</th><th>ржХрж╛рж░рзНржпржХрзНрж░ржо</th></tr></thead>
            <tbody id="payTableBody"></tbody>
          </table>
          </div>
        </div>
      </div>

      <!-- Add Payment -->
      <div id="payAddPanel" style="display:none">
        <div class="form-panel">
          <h4>тЮХ ржирждрзБржи ржкрзЗржорзЗржирзНржЯ ржПржирзНржЯрзНрж░рж┐</h4>
          <input type="hidden" id="editPayId">
          <div class="grid2">
            <div class="fg"><label>рж╕ржжрж╕рзНржп ржирж┐рж░рзНржмрж╛ржЪржи ржХрж░рзБржи *</label>
              <select id="pay-member"><option value="">-- рж╕ржжрж╕рзНржп ржмрзЗржЫрзЗ ржирж┐ржи --</option></select>
            </div>
            <div class="fg"><label>ЁЯТ░ ржкрж░рж┐ржорж╛ржг (ржЯрж╛ржХрж╛) *</label><input type="number" id="pay-amount" placeholder="ржпрзЗржоржи: 200"></div>
          </div>
          <div class="grid2">
            <div class="fg"><label>ЁЯУЕ ржорж╛рж╕</label>
              <select id="pay-month">
                <option value="">-- ржорж╛рж╕ --</option>
                <option value="ржЬрж╛ржирзБржпрж╝рж╛рж░рж┐">ржЬрж╛ржирзБржпрж╝рж╛рж░рж┐</option><option value="ржлрзЗржмрзНрж░рзБржпрж╝рж╛рж░рж┐">ржлрзЗржмрзНрж░рзБржпрж╝рж╛рж░рж┐</option>
                <option value="ржорж╛рж░рзНржЪ">ржорж╛рж░рзНржЪ</option><option value="ржПржкрзНрж░рж┐рж▓">ржПржкрзНрж░рж┐рж▓</option>
                <option value="ржорзЗ">ржорзЗ</option><option value="ржЬрзБржи">ржЬрзБржи</option>
                <option value="ржЬрзБрж▓рж╛ржЗ">ржЬрзБрж▓рж╛ржЗ</option><option value="ржЖржЧрж╕рзНржЯ">ржЖржЧрж╕рзНржЯ</option>
                <option value="рж╕рзЗржкрзНржЯрзЗржорзНржмрж░">рж╕рзЗржкрзНржЯрзЗржорзНржмрж░</option><option value="ржЕржХрзНржЯрзЛржмрж░">ржЕржХрзНржЯрзЛржмрж░</option>
                <option value="ржиржнрзЗржорзНржмрж░">ржиржнрзЗржорзНржмрж░</option><option value="ржбрж┐рж╕рзЗржорзНржмрж░">ржбрж┐рж╕рзЗржорзНржмрж░</option>
              </select>
            </div>
            <div class="fg"><label>ЁЯУЖ ржмржЫрж░</label><input type="number" id="pay-year" placeholder="ржпрзЗржоржи: 2025" value="2025"></div>
          </div>
          <div class="grid2">
            <div class="fg"><label>ржзрж░ржи</label>
              <select id="pay-type">
                <option value="ржорж╛рж╕рж┐ржХ ржЪрж╛ржБржжрж╛">ржорж╛рж╕рж┐ржХ ржЪрж╛ржБржжрж╛</option>
                <option value="ржмрж┐рж╢рзЗрж╖ ржЪрж╛ржБржжрж╛">ржмрж┐рж╢рзЗрж╖ ржЪрж╛ржБржжрж╛</option>
                <option value="ржбрзЛржирзЗрж╢ржи">ржбрзЛржирзЗрж╢ржи</option>
                <option value="ржЕржирзБрж╖рзНржарж╛ржи ржлрж┐">ржЕржирзБрж╖рзНржарж╛ржи ржлрж┐</option>
                <option value="ржЕржирзНржпрж╛ржирзНржп">ржЕржирзНржпрж╛ржирзНржп</option>
              </select>
            </div>
            <div class="fg"><label>ЁЯУЭ ржирзЛржЯ (ржРржЪрзНржЫрж┐ржХ)</label><input type="text" id="pay-note" placeholder="ржпрзЗржоржи: рж░ржоржЬрж╛ржи ржмрж┐рж╢рзЗрж╖ ржЪрж╛ржБржжрж╛"></div>
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:6px;">
            <button class="btn btn-g btn-lg" id="paySaveBtn" onclick="savePayment()">ЁЯТ╛ рж╕ржВрж░ржХрзНрж╖ржг ржХрж░рзБржи</button>
            <button class="btn btn-b btn-lg" onclick="switchPayTab('list',document.querySelector('.ptab'))">тЖР ржлрж┐рж░рзЗ ржпрж╛ржи</button>
          </div>
        </div>
      </div>

      <!-- Payment Summary -->
      <div id="paySummaryPanel" style="display:none">
        <div id="paySummaryContent"></div>
      </div>
    </div>

    <!-- тХРтХР REPORTS тХРтХР -->
    <div id="s-reports" style="display:none">
      <div class="form-panel">
        <h4>ЁЯУе рж░рж┐ржкрзЛрж░рзНржЯ ржбрж╛ржЙржирж▓рзЛржб ржХрж░рзБржи</h4>
        <p style="color:rgba(255,255,255,.5);font-size:13px;margin-bottom:20px;">рж╕ржжрж╕рзНржпржжрзЗрж░ рждржерзНржп ржУ ржЪрж╛ржБржжрж╛рж░ рж░рзЗржХрж░рзНржб ржбрж╛ржЙржирж▓рзЛржб ржХрж░рзБржиред</p>
        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:14px;">
          <div style="padding:20px;background:var(--glass2);border:1px solid var(--b1);border-radius:14px;text-align:center;">
            <div style="font-size:2.5rem;margin-bottom:10px">ЁЯСе</div>
            <div style="color:var(--sgold);font-weight:700;margin-bottom:6px">рж╕ржжрж╕рзНржп рждрж╛рж▓рж┐ржХрж╛ (Excel)</div>
            <div style="color:rgba(255,255,255,.4);font-size:12px;margin-bottom:14px">рж╕ржХрж▓ approved рж╕ржжрж╕рзНржпрзЗрж░ рждржерзНржп</div>
            <button class="btn btn-g" onclick="downloadMembersCSV()">ЁЯУе ржбрж╛ржЙржирж▓рзЛржб ржХрж░рзБржи</button>
          </div>
          <div style="padding:20px;background:var(--glass2);border:1px solid var(--b1);border-radius:14px;text-align:center;">
            <div style="font-size:2.5rem;margin-bottom:10px">ЁЯТ░</div>
            <div style="color:var(--sgold);font-weight:700;margin-bottom:6px">ржкрзЗржорзЗржирзНржЯ рж░рж┐ржкрзЛрж░рзНржЯ (Excel)</div>
            <div style="color:rgba(255,255,255,.4);font-size:12px;margin-bottom:14px">рж╕ржХрж▓ ржЪрж╛ржБржжрж╛ ржУ ржкрзЗржорзЗржирзНржЯрзЗрж░ рждрж╛рж▓рж┐ржХрж╛</div>
            <button class="btn btn-g" onclick="downloadPaymentsCSV()">ЁЯУе ржбрж╛ржЙржирж▓рзЛржб ржХрж░рзБржи</button>
          </div>
          <div style="padding:20px;background:var(--glass2);border:1px solid var(--b1);border-radius:14px;text-align:center;">
            <div style="font-size:2.5rem;margin-bottom:10px">ЁЯУК</div>
            <div style="color:var(--sgold);font-weight:700;margin-bottom:6px">рж╕ржжрж╕рзНржп рж╕рж╛рж░рж╕ржВржХрзНрж╖рзЗржк</div>
            <div style="color:rgba(255,255,255,.4);font-size:12px;margin-bottom:14px">ржПрж▓рж╛ржХрж╛ ржУ ржкржжржмрж┐ ржЕржирзБржпрж╛ржпрж╝рзА</div>
            <button class="btn btn-g" onclick="downloadSummaryCSV()">ЁЯУе ржбрж╛ржЙржирж▓рзЛржб ржХрж░рзБржи</button>
          </div>
          <div style="padding:20px;background:var(--glass2);border:1px solid var(--b1);border-radius:14px;text-align:center;">
            <div style="font-size:2.5rem;margin-bottom:10px">ЁЯЦия╕П</div>
            <div style="color:var(--sgold);font-weight:700;margin-bottom:6px">рж╕ржжрж╕рзНржп рждрж╛рж▓рж┐ржХрж╛ (Print)</div>
            <div style="color:rgba(255,255,255,.4);font-size:12px;margin-bottom:14px">ржкрзНрж░рж┐ржирзНржЯржпрзЛржЧрзНржп рждрж╛рж▓рж┐ржХрж╛</div>
            <button class="btn btn-g" onclick="printMembersList()">ЁЯЦия╕П ржкрзНрж░рж┐ржирзНржЯ ржХрж░рзБржи</button>
          </div>
        </div>
      </div>
    </div>

  </div><!-- /content -->
</div><!-- /main -->

<!-- тХРтХР PAYMENT SECTION тХРтХР -->
<script>
// Payment/Reports sections will be injected dynamically
</script>

<!-- Member Detail Modal -->
<div id="memberDetailModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:500;padding:20px;overflow-y:auto;display:flex;align-items:center;justify-content:center;">
  <div style="background:rgba(13,46,13,.97);border:1px solid var(--b2);border-radius:20px;max-width:500px;width:100%;padding:28px;position:relative;">
    <button onclick="document.getElementById('memberDetailModal').style.display='none'" style="position:absolute;top:14px;right:14px;background:var(--glass2);border:1px solid var(--b1);color:#fff;width:30px;height:30px;border-radius:50%;cursor:pointer;font-size:14px;">тЬХ</button>
    <div id="memberDetailContent"></div>
    <div id="memberDetailActions" style="display:flex;gap:10px;margin-top:16px;flex-wrap:wrap;"></div>
  </div>
</div>

<!-- Edit Member Modal -->
<div id="editMemberModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:600;padding:20px;overflow-y:auto;align-items:flex-start;justify-content:center;">
  <div style="background:rgba(13,46,13,.98);border:1px solid var(--b2);border-radius:20px;max-width:580px;width:100%;padding:28px;position:relative;margin:30px auto;">
    <button onclick="document.getElementById('editMemberModal').style.display='none'" style="position:absolute;top:14px;right:14px;background:var(--glass2);border:1px solid var(--b1);color:#fff;width:30px;height:30px;border-radius:50%;cursor:pointer;font-size:14px;">тЬХ</button>
    <h3 style="color:var(--sgold);margin-bottom:20px;font-size:1.1rem;">тЬПя╕П рж╕ржжрж╕рзНржпрзЗрж░ рждржерзНржп рж╕ржорзНржкрж╛ржжржирж╛</h3>
    <div class="flash flash-ok" id="editFlash"></div>
    <input type="hidden" id="edit-uid">

    <!-- ржЫржмрж┐ ржкрж░рж┐ржмрж░рзНрждржи -->
    <div class="fg">
      <label>ЁЯУ╕ ржЫржмрж┐ ржкрж░рж┐ржмрж░рзНрждржи ржХрж░рзБржи (ржРржЪрзНржЫрж┐ржХ)</label>
      <div onclick="document.getElementById('editPhotoFile').click()" style="border:2px dashed rgba(240,180,41,.35);border-radius:12px;padding:14px;text-align:center;cursor:pointer;transition:all .3s;" onmouseover="this.style.borderColor='var(--gold)'" onmouseout="this.style.borderColor='rgba(240,180,41,.35)'">
        <input type="file" id="editPhotoFile" accept="image/*" style="display:none" onchange="editPreviewPhoto(this)">
        <img id="editPhotoPreview" src="" style="display:none;width:80px;height:80px;object-fit:cover;border-radius:50%;border:3px solid var(--gold);margin:0 auto 6px;">
        <div id="editPhotoPlaceholder" style="color:rgba(255,255,255,.4);font-size:13px;">ЁЯУ╖ ржХрзНрж▓рж┐ржХ ржХрж░рзЗ ржирждрзБржи ржЫржмрж┐ ржмрзЗржЫрзЗ ржирж┐ржи</div>
      </div>
    </div>

    <div class="grid2">
      <div class="fg"><label>ЁЯСд ржкрзБрж░рзЛ ржирж╛ржо *</label><input type="text" id="edit-name" placeholder="ржирж╛ржо"></div>
      <div class="fg"><label>ЁЯУЮ ржорзЛржмрж╛ржЗрж▓ ржиржорзНржмрж░</label><input type="tel" id="edit-phone" placeholder="01XXXXXXXXX"></div>
    </div>
    <div class="grid2">
      <div class="fg"><label>ЁЯУН ржЧрзНрж░рж╛ржо/ржПрж▓рж╛ржХрж╛ *</label>
        <select id="edit-area">
          <option value="">-- ржЧрзНрж░рж╛ржо ржмрзЗржЫрзЗ ржирж┐ржи --</option>
          <option>ржХрж╛ржирзНржжрж┐рж░ржкрж╛ржбрж╝рж╛</option><option>ржЗржирж╕рж╛ржл ржиржЧрж░</option><option>рж╣рж▓ржжрж╛рж░ ржкрж╛ржбрж╝рж╛</option>
          <option>ржЪрж░ржкрж╛ржбрж╝рж╛</option><option>ржЪрж╛ржЗржбрзБржмрж╛</option><option>ржорзЛрж╣рж╛ржорзНржоржжржкрзБрж░</option>
          <option>ржирж┐ржЪржкрж╛ржбрж╝рж╛</option><option>рж╕рзЛржирж╛рждрж▓рж╛</option><option>ржЕржирзНржпрж╛ржирзНржп</option>
        </select>
      </div>
      <div class="fg"><label>тнР ржкржжржмрж┐</label>
        <select id="edit-position">
          <option value="рж╕ржжрж╕рзНржп">рж╕ржжрж╕рзНржп</option><option value="рж╕ржнрж╛ржкрждрж┐">рж╕ржнрж╛ржкрждрж┐</option>
          <option value="рж╕рж╛ржзрж╛рж░ржг рж╕ржорзНржкрж╛ржжржХ">рж╕рж╛ржзрж╛рж░ржг рж╕ржорзНржкрж╛ржжржХ</option><option value="рж╕рж╣-рж╕ржнрж╛ржкрждрж┐">рж╕рж╣-рж╕ржнрж╛ржкрждрж┐</option>
          <option value="ржХрзЛрж╖рж╛ржзрзНржпржХрзНрж╖">ржХрзЛрж╖рж╛ржзрзНржпржХрзНрж╖</option><option value="ржХрж╛рж░рзНржпржирж┐рж░рзНржмрж╛рж╣рзА рж╕ржжрж╕рзНржп">ржХрж╛рж░рзНржпржирж┐рж░рзНржмрж╛рж╣рзА рж╕ржжрж╕рзНржп</option>
          <option value="рж╕рзНржмрзЗржЪрзНржЫрж╛рж╕рзЗржмрзА">рж╕рзНржмрзЗржЪрзНржЫрж╛рж╕рзЗржмрзА</option>
        </select>
      </div>
    </div>
    <div class="grid2">
      <div class="fg"><label>ЁЯй╕ рж░ржХрзНрждрзЗрж░ ржЧрзНрж░рзБржк</label>
        <select id="edit-blood">
          <option value="">-- рж░ржХрзНрждрзЗрж░ ржЧрзНрж░рзБржк --</option>
          <option>A+</option><option>A-</option><option>B+</option><option>B-</option>
          <option>AB+</option><option>AB-</option><option>O+</option><option>O-</option>
        </select>
      </div>
      <div class="fg"><label>тЪд рж▓рж┐ржЩрзНржЧ</label>
        <select id="edit-gender">
          <option value="">-- рж▓рж┐ржЩрзНржЧ --</option>
          <option value="ржкрзБрж░рзБрж╖">ржкрзБрж░рзБрж╖</option><option value="ржорж╣рж┐рж▓рж╛">ржорж╣рж┐рж▓рж╛</option><option value="ржЕржирзНржпрж╛ржирзНржп">ржЕржирзНржпрж╛ржирзНржп</option>
        </select>
      </div>
    </div>
    <div class="grid2">
      <div class="fg"><label>ЁЯОВ ржЬржирзНржо рждрж╛рж░рж┐ржЦ</label><input type="date" id="edit-dob"></div>
      <div class="fg"><label>ЁЯУз ржЗржорзЗржЗрж▓</label><input type="email" id="edit-email" placeholder="ржРржЪрзНржЫрж┐ржХ"></div>
    </div>
    <div class="fg"><label>ЁЯПа рж╕ржорзНржкрзВрж░рзНржг ржарж┐ржХрж╛ржирж╛</label><input type="text" id="edit-address" placeholder="ржЧрзНрж░рж╛ржо, ржЙржкржЬрзЗрж▓рж╛, ржЬрзЗрж▓рж╛"></div>
    <div class="fg"><label>ЁЯЖФ рж╕ржжрж╕рзНржп ID (ржкрж░рж┐ржмрж░рзНрждржи рж╕ржорзНржнржм)</label><input type="text" id="edit-memberId" placeholder="ржпрзЗржоржи: 2025-001"></div>
    <div class="fg"><label>ЁЯУЛ ржЕржмрж╕рзНржерж╛</label>
      <select id="edit-status">
        <option value="approved">тЬЕ ржЕржирзБржорзЛржжрж┐ржд</option>
        <option value="pending">тП│ ржкрзЗржирзНржбрж┐ржВ</option>
        <option value="rejected">тЭМ ржкрзНрж░рждрзНржпрж╛ржЦрзНржпрж╛ржд</option>
      </select>
    </div>
    <!-- Upload progress -->
    <div id="editUploadProgress" style="display:none;margin-bottom:12px">
      <div style="background:rgba(255,255,255,.1);border-radius:4px;height:6px;overflow:hidden;">
        <div id="editUploadBar" style="height:100%;background:linear-gradient(90deg,var(--gold),var(--sgold));width:0%;transition:width .3s;"></div>
      </div>
      <span id="editUploadTxt" style="color:var(--text2);font-size:12px;margin-top:4px;display:block"></span>
    </div>
    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:6px;">
      <button class="btn btn-g btn-lg" id="editSaveBtn" onclick="saveEditedMember()">ЁЯТ╛ ржкрж░рж┐ржмрж░рзНрждржи рж╕ржВрж░ржХрзНрж╖ржг</button>
      <button class="btn btn-r btn-lg" onclick="document.getElementById('editMemberModal').style.display='none'">ржмрж╛рждрж┐рж▓ ржХрж░рзБржи</button>
    </div>
  </div>
</div>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
import { getAuth, onAuthStateChanged, signOut, sendPasswordResetEmail } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
import { getFirestore, collection, doc, getDoc, getDocs, setDoc, updateDoc, deleteDoc, query, where, orderBy, onSnapshot, serverTimestamp, addDoc, limit } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

const firebaseConfig = {
  apiKey: "AIzaSyDwzJgWcc4XPt4czcXpVFkHTniJFISpO7I",
  authDomain: "somaj-kallyan.firebaseapp.com",
  projectId: "somaj-kallyan",
  appId: "1:392871962816:web:0f7ebbc36a3d8c784da525"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const CLOUDINARY_URL = 'https://api.cloudinary.com/v1_1/dasurbavl/image/upload';
const UPLOAD_PRESET = 'somaj-kallyan-upload';
const SUPER_ADMIN = 'issaidur999@gmail.com';

let currentUser = null;
let currentUserData = null;
let allMembers = [];
let allPending = [];

// тФАтФА Auth Guard
onAuthStateChanged(auth, async (user) => {
  if (!user) { window.location.href = 'login.html'; return; }
  const userDoc = await getDoc(doc(db, 'users', user.uid));
  if (!userDoc.exists()) { window.location.href = 'login.html'; return; }
  const data = userDoc.data();
  if (data.status !== 'approved' || (data.role !== 'admin' && data.role !== 'superadmin')) {
    window.location.href = 'login.html'; return;
  }
  currentUser = user;
  currentUserData = data;
  initAdmin(data);
});

function initAdmin(data) {
  document.getElementById('sidebarName').textContent = data.name || user.email;
  document.getElementById('sidebarRole').textContent = data.role === 'superadmin' ? 'Super Admin' : 'Admin';
  document.getElementById('adminBadge').textContent = data.role === 'superadmin' ? 'тнР Super Admin' : 'ЁЯФС Admin';
  if (data.photoUrl) {
    document.getElementById('sidebarAv').innerHTML = `<img src="${data.photoUrl}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`;
  } else {
    document.getElementById('sidebarAv').textContent = (data.name||'A').charAt(0);
  }
  // Hide admin management for non-superadmin
  if (data.role !== 'superadmin') document.getElementById('nav-admins').style.display = 'none';

  loadDashboard();
  loadPending();
  loadMembers();
  if (data.role === 'superadmin') loadAdmins();
  loadNotices();
  loadGallery();
  loadStats();
}

// тФАтФА DASHBOARD
async function loadDashboard() {
  const usersSnap = await getDocs(collection(db, 'users'));
  const pendSnap = await getDocs(query(collection(db, 'users'), where('status','==','pending')));
  const approvedSnap = await getDocs(query(collection(db, 'users'), where('status','==','approved')));
  const noticesSnap = await getDocs(collection(db, 'notices'));

  document.getElementById('d-total').textContent = usersSnap.size;
  document.getElementById('d-approved').textContent = approvedSnap.size;
  document.getElementById('d-pending').textContent = pendSnap.size;
  document.getElementById('d-notices').textContent = noticesSnap.size;
  document.getElementById('pendingBadge').textContent = pendSnap.size;

  // Payment total
  try {
    const paySnap = await getDocs(collection(db,'payments'));
    const total = paySnap.docs.reduce((s,d)=>s+parseFloat(d.data().amount||0),0);
    document.getElementById('d-payments').textContent = 'рз│'+total;
  } catch(e){}

  // Recent pending list
  const pend = pendSnap.docs.slice(0,5).map(d => d.data());
  const dashPendingList = document.getElementById('dashPendingList');
  if (pend.length === 0) {
    dashPendingList.innerHTML = '<div class="empty"><div class="empty-ico">тЬЕ</div>ржХрзЛржирзЛ ржкрзЗржирзНржбрж┐ржВ ржЖржмрзЗржжржи ржирзЗржЗ</div>';
    return;
  }
  dashPendingList.innerHTML = `<div style="overflow-x:auto"><table>
    <thead><tr><th>рж╕ржжрж╕рзНржп</th><th>ржПрж▓рж╛ржХрж╛</th><th>ржлрзЛржи</th><th>ржХрж╛рж░рзНржпржХрзНрж░ржо</th></tr></thead>
    <tbody>${pend.map(m=>`<tr>
      <td><div class="mem-info">
        <div class="mem-av">${m.photoUrl?`<img src="${m.photoUrl}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`:m.name.charAt(0)}</div>
        <div><div class="mem-name">${m.name}</div><div class="mem-sub">${m.email||''}</div></div>
      </div></td>
      <td>${m.area||'-'}</td>
      <td>${m.phone||'-'}</td>
      <td><button class="btn btn-g" onclick="approveUser('${m.uid}')">тЬЕ ржЕржирзБржорзЛржжржи</button>
      <button class="btn btn-r" style="margin-left:6px" onclick="rejectUser('${m.uid}')">тЭМ ржкрзНрж░рждрзНржпрж╛ржЦрзНржпрж╛ржи</button></td>
    </tr>`).join('')}</tbody>
  </table></div>`;
}

// тФАтФА PENDING REQUESTS
async function loadPending() {
  const snap = await getDocs(query(collection(db, 'users'), where('status','==','pending')));
  allPending = snap.docs.map(d => ({...d.data(), uid: d.id}));
  renderPending(allPending);
}

function renderPending(list) {
  const el = document.getElementById('pendingList');
  if (list.length === 0) { el.innerHTML = '<div class="empty"><div class="empty-ico">тЬЕ</div>ржХрзЛржирзЛ ржкрзЗржирзНржбрж┐ржВ ржЖржмрзЗржжржи ржирзЗржЗ</div>'; return; }
  el.innerHTML = `<div style="overflow-x:auto"><table>
    <thead><tr><th>рж╕ржжрж╕рзНржп</th><th>ржПрж▓рж╛ржХрж╛</th><th>ржлрзЛржи</th><th>рж░ржХрзНржд</th><th>рждрж╛рж░рж┐ржЦ</th><th>ржХрж╛рж░рзНржпржХрзНрж░ржо</th></tr></thead>
    <tbody>${list.map(m=>`<tr>
      <td><div class="mem-info">
        <div class="mem-av">${m.photoUrl?`<img src="${m.photoUrl}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`:m.name.charAt(0)}</div>
        <div><div class="mem-name">${m.name}</div><div class="mem-sub">${m.email||''}</div></div>
      </div></td>
      <td>${m.area||'-'}</td><td>${m.phone||'-'}</td><td>${m.bloodGroup||'-'}</td>
      <td>${m.createdAt?.seconds?new Date(m.createdAt.seconds*1000).toLocaleDateString('bn-BD'):'-'}</td>
      <td style="display:flex;gap:6px;flex-wrap:wrap">
        <button class="btn btn-g" onclick="approveUser('${m.uid}')">тЬЕ ржЕржирзБржорзЛржжржи</button>
        <button class="btn btn-r" onclick="rejectUser('${m.uid}')">тЭМ ржкрзНрж░рждрзНржпрж╛ржЦрзНржпрж╛ржи</button>
        <button class="btn btn-b" onclick="viewMember('${m.uid}')">ЁЯСБ ржжрзЗржЦрзБржи</button>
        <button class="btn" style="background:rgba(155,89,182,.2);border:1px solid rgba(155,89,182,.4);color:#c39bd3" onclick="editMember('${m.uid}')">тЬПя╕П ржПржбрж┐ржЯ</button>
      </td>
    </tr>`).join('')}</tbody>
  </table></div>`;
}

window.searchPending = function(q) {
  const f = allPending.filter(m => m.name?.toLowerCase().includes(q.toLowerCase()) || m.area?.toLowerCase().includes(q.toLowerCase()));
  renderPending(f);
};

// тФАтФА MEMBERS
async function loadMembers() {
  const snap = await getDocs(query(collection(db, 'users'), where('status','==','approved')));
  allMembers = snap.docs.map(d => ({...d.data(), uid: d.id}));
  renderMembers(allMembers);
  // Also populate admin select
  const sel = document.getElementById('adminSelectMember');
  if (sel) {
    sel.innerHTML = '<option value="">-- рж╕ржжрж╕рзНржп ржмрзЗржЫрзЗ ржирж┐ржи --</option>';
    allMembers.filter(m=>m.role==='member').forEach(m => {
      sel.innerHTML += `<option value="${m.uid}">${m.name} тАФ ${m.area||''}</option>`;
    });
  }
}

function renderMembers(list) {
  const tbody = document.getElementById('memberTableBody');
  if (!tbody) return;
  if (list.length === 0) { tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:30px;color:rgba(255,255,255,.3)">ржХрзЛржирзЛ рж╕ржжрж╕рзНржп ржирзЗржЗ</td></tr>'; return; }
  tbody.innerHTML = list.map(m=>`<tr>
    <td><div class="mem-info">
      <div class="mem-av">${m.photoUrl?`<img src="${m.photoUrl}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`:m.name?.charAt(0)||'?'}</div>
      <div><div class="mem-name">${m.name||'-'}</div><div class="mem-sub">${m.email||''}</div></div>
    </div></td>
    <td>${m.memberId||'тАФ'}</td>
    <td>${m.area||'-'}</td>
    <td>${m.phone||'-'}</td>
    <td><select onchange="updatePosition('${m.uid}',this.value)" style="background:var(--glass2);border:1px solid var(--b1);color:#fff;padding:4px 8px;border-radius:6px;font-size:12px;font-family:inherit;outline:none;">
      ${['рж╕ржжрж╕рзНржп','рж╕ржнрж╛ржкрждрж┐','рж╕рж╛ржзрж╛рж░ржг рж╕ржорзНржкрж╛ржжржХ','рж╕рж╣-рж╕ржнрж╛ржкрждрж┐','ржХрзЛрж╖рж╛ржзрзНржпржХрзНрж╖','ржХрж╛рж░рзНржпржирж┐рж░рзНржмрж╛рж╣рзА рж╕ржжрж╕рзНржп'].map(p=>`<option value="${p}"${m.position===p?' selected':''}>${p}</option>`).join('')}
    </select></td>
    <td>${m.bloodGroup||'-'}</td>
    <td><span class="badge ${m.role==='superadmin'?'b-superadmin':m.role==='admin'?'b-admin':'b-approved'}">${m.role==='superadmin'?'Super Admin':m.role==='admin'?'Admin':'рж╕ржжрж╕рзНржп'}</span></td>
    <td style="display:flex;gap:6px;flex-wrap:wrap;">
      <button class="btn btn-b" onclick="viewMember('${m.uid}')">ЁЯСБ</button>
      <button class="btn btn-g" onclick="editMember('${m.uid}')">тЬПя╕П</button>
      <button class="btn btn-r" onclick="removeMember('${m.uid}')">ЁЯЧС</button>
    </td>
  </tr>`).join('');
}

window.searchMembers = function(q) {
  const f = allMembers.filter(m =>
    m.name?.toLowerCase().includes(q.toLowerCase()) ||
    m.area?.toLowerCase().includes(q.toLowerCase()) ||
    m.phone?.includes(q) ||
    m.memberId?.includes(q)
  );
  renderMembers(f);
};

// тФАтФА APPROVE / REJECT
window.approveUser = async function(uid) {
  if (!confirm('ржПржЗ рж╕ржжрж╕рзНржпржХрзЗ ржЕржирзБржорзЛржжржи ржХрж░ржмрзЗржи?')) return;
  // Generate member ID: year-serial
  const year = new Date().getFullYear();
  const approvedSnap = await getDocs(query(collection(db,'users'),where('status','==','approved')));
  const serial = String(approvedSnap.size + 1).padStart(3, '0');
  const memberId = `${year}-${serial}`;

  await updateDoc(doc(db,'users',uid), {
    status: 'approved', memberId, approvedAt: serverTimestamp(), updatedAt: serverTimestamp()
  });
  // Remove from pending requests
  try { await deleteDoc(doc(db,'pendingRequests',uid)); } catch(e){}

  flash('pFlash', `тЬЕ рж╕ржжрж╕рзНржп ржЕржирзБржорзЛржжрж┐ржд рж╣ржпрж╝рзЗржЫрзЗред ID: ${memberId}`);
  flash('mFlash', `тЬЕ рж╕ржжрж╕рзНржп ржЕржирзБржорзЛржжрж┐рждред ID: ${memberId}`);
  loadPending(); loadMembers(); loadDashboard();
};

window.rejectUser = async function(uid) {
  if (!confirm('ржПржЗ ржЖржмрзЗржжржи ржкрзНрж░рждрзНржпрж╛ржЦрзНржпрж╛ржи ржХрж░ржмрзЗржи?')) return;
  await updateDoc(doc(db,'users',uid), {status:'rejected', updatedAt: serverTimestamp()});
  try { await deleteDoc(doc(db,'pendingRequests',uid)); } catch(e){}
  flash('pFlash','тЭМ ржЖржмрзЗржжржи ржкрзНрж░рждрзНржпрж╛ржЦрзНржпрж╛ржи ржХрж░рж╛ рж╣ржпрж╝рзЗржЫрзЗред');
  loadPending(); loadDashboard();
};

window.updatePosition = async function(uid, pos) {
  await updateDoc(doc(db,'users',uid), {position: pos, updatedAt: serverTimestamp()});
};

window.removeMember = async function(uid) {
  if (!confirm('ржПржЗ рж╕ржжрж╕рзНржпржХрзЗ ржорзБржЫрзЗ ржлрзЗрж▓ржмрзЗржи? ржПржЯрж┐ ржкрзВрж░рзНржмрж╛ржмрж╕рзНржерж╛ржпрж╝ ржлрзЗрж░рж╛ржирзЛ ржпрж╛ржмрзЗ ржирж╛ред')) return;
  await updateDoc(doc(db,'users',uid), {status:'removed', updatedAt: serverTimestamp()});
  flash('mFlash','ЁЯЧС рж╕ржжрж╕рзНржп ржорзБржЫрзЗ ржлрзЗрж▓рж╛ рж╣ржпрж╝рзЗржЫрзЗред');
  loadMembers();
};

// тФАтФА VIEW MEMBER DETAIL
window.viewMember = async function(uid) {
  const snap = await getDoc(doc(db,'users',uid));
  if (!snap.exists()) return;
  const m = snap.data();
  const modal = document.getElementById('memberDetailModal');
  modal.style.display = 'flex';
  document.getElementById('memberDetailContent').innerHTML = `
    <div style="text-align:center;margin-bottom:16px">
      <div style="width:90px;height:90px;border-radius:50%;border:3px solid var(--gold);margin:0 auto 10px;overflow:hidden;background:var(--g3);display:flex;align-items:center;justify-content:center;font-size:2rem;font-weight:700;">
        ${m.photoUrl?`<img src="${m.photoUrl}" style="width:100%;height:100%;object-fit:cover">`:m.name?.charAt(0)||'?'}
      </div>
      <div style="color:var(--sgold);font-size:1.2rem;font-weight:700;">${m.name||'-'}</div>
      <span class="badge ${m.status==='approved'?'b-approved':'b-pending'}" style="margin-top:6px;display:inline-block">${m.status==='approved'?'тЬЕ ржЕржирзБржорзЛржжрж┐ржд':'тП│ ржкрзЗржирзНржбрж┐ржВ'}</span>
      ${m.memberId?`<div style="color:var(--text2);font-size:12px;margin-top:4px">ID: ${m.memberId}</div>`:''}
    </div>
    <div style="display:grid;gap:8px">
      ${[['ЁЯУз ржЗржорзЗржЗрж▓',m.email],['ЁЯУЮ ржлрзЛржи',m.phone],['ЁЯУН ржПрж▓рж╛ржХрж╛',m.area],['ЁЯй╕ рж░ржХрзНржд',m.bloodGroup],['тЪд рж▓рж┐ржЩрзНржЧ',m.gender],['ЁЯОВ ржЬржирзНржо',m.dob],['ЁЯПа ржарж┐ржХрж╛ржирж╛',m.address]].map(([k,v])=>
        v?`<div style="display:flex;gap:8px;padding:8px 12px;background:var(--glass);border:1px solid var(--b1);border-radius:8px;font-size:13px"><span>${k}</span><span style="margin-left:auto;color:var(--sgold)">${v}</span></div>`:''
      ).join('')}
    </div>
  `;
  document.getElementById('memberDetailActions').innerHTML = `
    ${m.phone?`<a class="btn btn-g" href="tel:${m.phone}" style="text-decoration:none">ЁЯУЮ ржХрж▓ ржХрж░рзБржи</a>`:''}
    ${m.phone?`<a class="btn btn-b" href="https://wa.me/880${m.phone.replace(/^0/,'').replace(/-/g,'')}" target="_blank" style="text-decoration:none">ЁЯТм WhatsApp</a>`:''}
    ${m.status==='pending'?`<button class="btn btn-g" onclick="approveUser('${uid}');document.getElementById('memberDetailModal').style.display='none'">тЬЕ ржЕржирзБржорзЛржжржи</button>`:''}
    ${m.status==='pending'?`<button class="btn btn-r" onclick="rejectUser('${uid}');document.getElementById('memberDetailModal').style.display='none'">тЭМ ржкрзНрж░рждрзНржпрж╛ржЦрзНржпрж╛ржи</button>`:''}
  `;
};

// тФАтФА ADMIN MANAGEMENT
async function loadAdmins() {
  const snap = await getDocs(query(collection(db,'users'), where('role','in',['admin','superadmin'])));
  const list = snap.docs.map(d=>d.data());
  const tbody = document.getElementById('adminTableBody');
  if (!tbody) return;
  tbody.innerHTML = list.map(m=>`<tr>
    <td><div class="mem-info">
      <div class="mem-av">${m.photoUrl?`<img src="${m.photoUrl}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`:m.name?.charAt(0)||'?'}</div>
      <div><div class="mem-name">${m.name||'-'}</div></div>
    </div></td>
    <td>${m.email||'-'}</td>
    <td><span class="badge ${m.role==='superadmin'?'b-superadmin':'b-admin'}">${m.role==='superadmin'?'тнР Super Admin':'ЁЯФС Admin'}</span></td>
    <td>${m.role==='superadmin'?'<span style="color:rgba(255,255,255,.3);font-size:12px">ржкрж░рж┐ржмрж░рзНрждржи ржХрж░рж╛ ржпрж╛ржмрзЗ ржирж╛</span>':
      `<div style="display:flex;gap:6px;flex-wrap:wrap;"><button class="btn btn-r" onclick="removeAdmin('${m.uid}')">Admin рж╕рж░рж╛ржи</button>${m.email?`<button class="btn btn-b" onclick="sendPassReset('${m.email}')">ЁЯФС ржкрж╛рж╕ржУржпрж╝рж╛рж░рзНржб рж░рж┐рж╕рзЗржЯ</button>`:''}</div>`}</td>
  </tr>`).join('');
}

window.makeAdmin = async function() {
  const uid = document.getElementById('adminSelectMember').value;
  const role = document.getElementById('adminRole').value;
  if (!uid) { flash('aFlash','тЪая╕П рж╕ржжрж╕рзНржп ржирж┐рж░рзНржмрж╛ржЪржи ржХрж░рзБржиред','err'); return; }
  if (currentUserData?.role !== 'superadmin') { flash('aFlash','тЭМ рж╢рзБржзрзБ Super Admin ржПржЗ ржХрж╛ржЬ ржХрж░рждрзЗ ржкрж╛рж░ржмрзЗржиред','err'); return; }
  await updateDoc(doc(db,'users',uid), {role, updatedAt: serverTimestamp()});
  flash('aFlash','тЬЕ Admin ржирж┐ржпрзБржХрзНржд ржХрж░рж╛ рж╣ржпрж╝рзЗржЫрзЗред');
  loadAdmins(); loadMembers();
};

window.removeAdmin = async function(uid) {
  if (!confirm('Admin ржерзЗржХрзЗ рж╕рж░рж┐ржпрж╝рзЗ рж╕рж╛ржзрж╛рж░ржг рж╕ржжрж╕рзНржп ржХрж░ржмрзЗржи?')) return;
  await updateDoc(doc(db,'users',uid), {role:'member', updatedAt: serverTimestamp()});
  flash('aFlash','тЬЕ Admin рж╕рж░рж╛ржирзЛ рж╣ржпрж╝рзЗржЫрзЗред');
  loadAdmins(); loadMembers();
};

// тФАтФА NOTICES
async function loadNotices() {
  const snap = await getDocs(query(collection(db,'notices'), orderBy('createdAt','desc')));
  const list = snap.docs.map(d=>({...d.data(), id:d.id}));
  const el = document.getElementById('noticeList');
  if (!el) return;
  if (list.length===0) { el.innerHTML='<div class="empty"><div class="empty-ico">ЁЯУв</div>ржХрзЛржирзЛ ржирзЛржЯрж┐рж╢ ржирзЗржЗ</div>'; return; }
  const typeColors={urgent:'#f44336',info:'#2196f3',success:'#4caf50',default:'var(--gold)'};
  el.innerHTML = list.map(n=>`<div class="notice-row">
    <div class="notice-type-dot" style="background:${typeColors[n.type]||typeColors.default}"></div>
    <div class="notice-content">
      <div class="notice-title">${n.title||'-'}</div>
      <div class="notice-body">${n.body||''}</div>
      ${n.link?`<a href="${n.link}" target="_blank" style="display:inline-block;margin-top:4px;color:var(--sgold);font-size:12px;">ЁЯФЧ ${n.link}</a>`:''}
      <div class="notice-meta">ЁЯУЕ ${n.createdAt?.seconds?new Date(n.createdAt.seconds*1000).toLocaleDateString('bn-BD'):'-'} ┬╖ ${n.postedBy||'Admin'}</div>
    </div>
    ${n.photoUrl?`<img src="${n.photoUrl}" style="width:70px;height:70px;object-fit:cover;border-radius:8px;border:1px solid var(--b1)">` : ''}
    <div style="display:flex;flex-direction:column;gap:6px;margin-left:10px">
      <button class="btn btn-b" onclick="editNotice('${n.id}')">тЬПя╕П</button>
      <button class="btn btn-r" onclick="deleteNotice('${n.id}')">ЁЯЧС</button>
    </div>
  </div>`).join('');
}

window.saveNotice = async function() {
  const title = document.getElementById('n-title').value.trim();
  const body = document.getElementById('n-body').value.trim();
  const type = document.getElementById('n-type').value;
  const link = document.getElementById('n-link').value.trim();
  const editId = document.getElementById('editNoticeId').value;
  const photoFile = document.getElementById('n-photo').files[0];
  if (!title || !body) { alert('рж╢рж┐рж░рзЛржирж╛ржо ржУ ржмрж┐ржмрж░ржг ржжрж┐ржиред'); return; }

  let photoUrl = null;
  if (photoFile) {
    const fd = new FormData();
    fd.append('file', photoFile);
    fd.append('upload_preset', UPLOAD_PRESET);
    fd.append('folder','somaj-kallyan/notices');
    const res = await fetch(CLOUDINARY_URL, {method:'POST',body:fd});
    const data = await res.json();
    photoUrl = data.secure_url;
  }

  const payload = {title, body, type, link: link||'', postedBy: currentUserData?.name||'Admin', updatedAt: serverTimestamp()};
  if (photoUrl) payload.photoUrl = photoUrl;

  if (editId) {
    await updateDoc(doc(db,'notices',editId), payload);
    flash('nFlash','тЬЕ ржирзЛржЯрж┐рж╢ ржЖржкржбрзЗржЯ рж╣ржпрж╝рзЗржЫрзЗред');
  } else {
    payload.createdAt = serverTimestamp();
    await addDoc(collection(db,'notices'), payload);
    flash('nFlash','тЬЕ ржирждрзБржи ржирзЛржЯрж┐рж╢ ржпрзЛржЧ рж╣ржпрж╝рзЗржЫрзЗред');
  }
  document.getElementById('editNoticeId').value='';
  document.getElementById('n-title').value='';
  document.getElementById('n-body').value='';
  document.getElementById('n-link').value='';
  switchNoticeTab('list', document.querySelector('.ptab'));
  loadNotices();
};

window.editNotice = async function(id) {
  const snap = await getDoc(doc(db,'notices',id));
  if (!snap.exists()) return;
  const n = snap.data();
  document.getElementById('editNoticeId').value = id;
  document.getElementById('n-title').value = n.title||'';
  document.getElementById('n-body').value = n.body||'';
  document.getElementById('n-type').value = n.type||'default';
  document.getElementById('n-link').value = n.link||'';
  document.getElementById('noticeFormTitle').textContent = 'тЬПя╕П ржирзЛржЯрж┐рж╢ рж╕ржорзНржкрж╛ржжржирж╛';
  switchNoticeTab('add', document.querySelectorAll('.ptab')[1]);
};

window.deleteNotice = async function(id) {
  if (!confirm('ржПржЗ ржирзЛржЯрж┐рж╢ ржорзБржЫрзЗ ржлрзЗрж▓ржмрзЗржи?')) return;
  await deleteDoc(doc(db,'notices',id));
  flash('nFlash','ЁЯЧС ржирзЛржЯрж┐рж╢ ржорзБржЫрзЗ ржлрзЗрж▓рж╛ рж╣ржпрж╝рзЗржЫрзЗред');
  loadNotices();
};

// тФАтФА GALLERY
async function loadGallery() {
  const snap = await getDocs(query(collection(db,'gallery'), orderBy('createdAt','desc')));
  const list = snap.docs.map(d=>({...d.data(),id:d.id}));
  const el = document.getElementById('galAdminGrid');
  if (!el) return;
  if (list.length===0) { el.innerHTML='<div class="empty" style="grid-column:1/-1"><div class="empty-ico">ЁЯУ╖</div>ржХрзЛржирзЛ ржЫржмрж┐ ржирзЗржЗ</div>'; return; }
  el.innerHTML = list.map(g=>`
    <div style="border-radius:12px;overflow:hidden;border:1px solid var(--b1);background:var(--glass);position:relative;">
      <img src="${g.src}" style="width:100%;height:140px;object-fit:cover;display:block">
      <div style="padding:10px">
        <div style="color:var(--sgold);font-size:12px;font-weight:600;margin-bottom:4px">${g.caption||'-'}</div>
        <div style="color:rgba(255,255,255,.4);font-size:11px">${g.cat||'-'}</div>
      </div>
      <button class="btn btn-r" onclick="deleteGalPhoto('${g.id}')" style="position:absolute;top:8px;right:8px;padding:4px 8px">ЁЯЧС</button>
    </div>`).join('');
}

window.previewGalPhoto = function(input) {
  const wrap = document.getElementById('galPreviewWrap');
  if (input.files[0]) {
    const url = URL.createObjectURL(input.files[0]);
    wrap.innerHTML = `<img class="img-preview" src="${url}">`;
  }
};

window.uploadGalleryPhoto = async function() {
  const file = document.getElementById('g-photo').files[0];
  const caption = document.getElementById('g-caption').value.trim();
  const cat = document.getElementById('g-cat').value;
  if (!file || !caption) { alert('ржЫржмрж┐ ржУ ржмрж┐ржмрж░ржг ржжрж┐ржиред'); return; }
  const btn = event.target; btn.disabled=true; btn.textContent='тП│ ржЖржкрж▓рзЛржб рж╣ржЪрзНржЫрзЗ...';
  const fd = new FormData();
  fd.append('file',file); fd.append('upload_preset',UPLOAD_PRESET); fd.append('folder','somaj-kallyan/gallery');
  const res = await fetch(CLOUDINARY_URL,{method:'POST',body:fd});
  const data = await res.json();
  await addDoc(collection(db,'gallery'),{src:data.secure_url, caption, cat, uploadedBy:currentUserData?.name||'Admin', createdAt:serverTimestamp()});
  flash('gFlash','тЬЕ ржЫржмрж┐ ржпрзЛржЧ рж╣ржпрж╝рзЗржЫрзЗред');
  btn.disabled=false; btn.textContent='ЁЯУд ржЖржкрж▓рзЛржб ржХрж░рзБржи';
  document.getElementById('g-photo').value='';
  document.getElementById('g-caption').value='';
  document.getElementById('galPreviewWrap').innerHTML='';
  loadGallery();
  switchGalTab('list',document.querySelector('.ptab'));
};

window.deleteGalPhoto = async function(id) {
  if (!confirm('ржЫржмрж┐ ржорзБржЫрзЗ ржлрзЗрж▓ржмрзЗржи?')) return;
  await deleteDoc(doc(db,'gallery',id));
  flash('gFlash','ЁЯЧС ржЫржмрж┐ ржорзБржЫрзЗ ржлрзЗрж▓рж╛ рж╣ржпрж╝рзЗржЫрзЗред');
  loadGallery();
};

// тФАтФА STATS
async function loadStats() {
  const snap = await getDoc(doc(db,'config','stats'));
  if (!snap.exists()) return;
  const s = snap.data();
  const fields={members:'st-members',branches:'st-branches',activities:'st-activities',years:'st-years',students:'st-students',trees:'st-trees',blood:'st-blood',families:'st-families'};
  Object.entries(fields).forEach(([k,id])=>{ const el=document.getElementById(id); if(el&&s[k]) el.value=s[k]; });
}

window.saveStats = async function() {
  const fields={members:'st-members',branches:'st-branches',activities:'st-activities',years:'st-years',students:'st-students',trees:'st-trees',blood:'st-blood',families:'st-families'};
  const data={};
  Object.entries(fields).forEach(([k,id])=>{ const v=document.getElementById(id)?.value; if(v) data[k]=parseInt(v)||0; });
  await setDoc(doc(db,'config','stats'), {...data, updatedAt:serverTimestamp()});
  flash('stFlash','тЬЕ ржкрж░рж┐рж╕ржВржЦрзНржпрж╛ржи ржЖржкржбрзЗржЯ рж╣ржпрж╝рзЗржЫрзЗред');
};


window.sendPassReset = async function(email) {
  if (!confirm(`${email} тАФ ржПржЗ ржЗржорзЗржЗрж▓рзЗ ржкрж╛рж╕ржУржпрж╝рж╛рж░рзНржб рж░рж┐рж╕рзЗржЯ рж▓рж┐ржВржХ ржкрж╛ржарж╛ржмрзЗржи?`)) return;
  try {
    await sendPasswordResetEmail(auth, email);
    flash('aFlash', `тЬЕ ржкрж╛рж╕ржУржпрж╝рж╛рж░рзНржб рж░рж┐рж╕рзЗржЯ ржЗржорзЗржЗрж▓ ржкрж╛ржарж╛ржирзЛ рж╣ржпрж╝рзЗржЫрзЗ: ${email}`);
  } catch(e) {
    flash('aFlash', 'тЭМ ржЗржорзЗржЗрж▓ ржкрж╛ржарж╛ржирзЛ ржпрж╛ржпрж╝ржирж┐: ' + e.message, 'err');
  }
};

// тФАтФА Logout
window.doLogout = function() { signOut(auth).then(()=>window.location.href='login.html'); };

// тФАтФА EDIT MEMBER
window.editMember = async function(uid) {
  const snap = await getDoc(doc(db,'users',uid));
  if (!snap.exists()) return;
  const m = snap.data();
  document.getElementById('edit-uid').value = uid;
  document.getElementById('edit-name').value = m.name||'';
  document.getElementById('edit-phone').value = m.phone||'';
  document.getElementById('edit-email').value = m.email||'';
  document.getElementById('edit-address').value = m.address||'';
  document.getElementById('edit-dob').value = m.dob||'';
  document.getElementById('edit-memberId').value = m.memberId||'';
  // selects
  const setVal = (id, val) => { const el=document.getElementById(id); if(el && val) { for(let o of el.options) if(o.value===val) { o.selected=true; break; } } };
  setVal('edit-area', m.area||'');
  setVal('edit-position', m.position||'рж╕ржжрж╕рзНржп');
  setVal('edit-blood', m.bloodGroup||'');
  setVal('edit-gender', m.gender||'');
  setVal('edit-status', m.status||'approved');
  // photo preview
  const prev = document.getElementById('editPhotoPreview');
  const ph = document.getElementById('editPhotoPlaceholder');
  if (m.photoUrl) {
    prev.src = m.photoUrl; prev.style.display='block'; ph.style.display='none';
  } else { prev.style.display='none'; ph.style.display='block'; }
  document.getElementById('editMemberModal').style.display='flex';
};

window.editPreviewPhoto = function(input) {
  if (!input.files[0]) return;
  const reader = new FileReader();
  reader.onload = e => {
    const prev = document.getElementById('editPhotoPreview');
    prev.src = e.target.result; prev.style.display='block';
    document.getElementById('editPhotoPlaceholder').style.display='none';
  };
  reader.readAsDataURL(input.files[0]);
};

window.saveEditedMember = async function() {
  const uid = document.getElementById('edit-uid').value;
  const name = document.getElementById('edit-name').value.trim();
  const phone = document.getElementById('edit-phone').value.trim();
  const area = document.getElementById('edit-area').value;
  const position = document.getElementById('edit-position').value;
  const blood = document.getElementById('edit-blood').value;
  const gender = document.getElementById('edit-gender').value;
  const dob = document.getElementById('edit-dob').value;
  const email = document.getElementById('edit-email').value.trim();
  const address = document.getElementById('edit-address').value.trim();
  const memberId = document.getElementById('edit-memberId').value.trim();
  const status = document.getElementById('edit-status').value;
  const photoFile = document.getElementById('editPhotoFile').files[0];

  if (!name) { editFlash('тЪая╕П ржирж╛ржо ржжрж┐ржиред','err'); return; }
  const btn = document.getElementById('editSaveBtn');
  btn.disabled=true; btn.textContent='тП│ рж╕ржВрж░ржХрзНрж╖ржг рж╣ржЪрзНржЫрзЗ...';

  try {
    let photoUrl = null;
    if (photoFile) {
      btn.textContent='ЁЯУ╕ ржЫржмрж┐ ржЖржкрж▓рзЛржб рж╣ржЪрзНржЫрзЗ...';
      const prog = document.getElementById('editUploadProgress');
      const bar = document.getElementById('editUploadBar');
      const txt = document.getElementById('editUploadTxt');
      prog.style.display='block';
      photoUrl = await new Promise((res, rej) => {
        const fd = new FormData();
        fd.append('file', photoFile); fd.append('upload_preset', UPLOAD_PRESET); fd.append('folder','somaj-kallyan/members');
        const xhr = new XMLHttpRequest();
        xhr.open('POST', CLOUDINARY_URL);
        xhr.upload.onprogress = e => { if(e.lengthComputable){ const p=Math.round(e.loaded/e.total*100); bar.style.width=p+'%'; txt.textContent='ржЖржкрж▓рзЛржб рж╣ржЪрзНржЫрзЗ... '+p+'%'; }};
        xhr.onload = () => xhr.status===200?res(JSON.parse(xhr.responseText).secure_url):rej(new Error('ржЖржкрж▓рзЛржб ржмрзНржпрж░рзНрже'));
        xhr.onerror = ()=>rej(new Error('ржирзЗржЯржУржпрж╝рж╛рж░рзНржХ рж╕ржорж╕рзНржпрж╛'));
        xhr.send(fd);
      });
      prog.style.display='none';
    }

    const updateData = {
      name, phone, area, position, bloodGroup:blood, gender, dob, email, address, memberId, status,
      updatedAt: serverTimestamp(), updatedBy: currentUserData?.name||'Admin'
    };
    if (photoUrl) updateData.photoUrl = photoUrl;

    await updateDoc(doc(db,'users',uid), updateData);
    editFlashMsg('тЬЕ рждржерзНржп рж╕ржлрж▓ржнрж╛ржмрзЗ ржЖржкржбрзЗржЯ рж╣ржпрж╝рзЗржЫрзЗ!','ok');
    loadMembers(); loadPending(); loadDashboard();
    setTimeout(()=>{ document.getElementById('editMemberModal').style.display='none'; }, 1500);
  } catch(e) {
    editFlashMsg('тЭМ рж╕ржорж╕рзНржпрж╛ рж╣ржпрж╝рзЗржЫрзЗ: '+e.message,'err');
  } finally {
    btn.disabled=false; btn.textContent='ЁЯТ╛ ржкрж░рж┐ржмрж░рзНрждржи рж╕ржВрж░ржХрзНрж╖ржг';
  }
};

function editFlashMsg(msg, type='ok') {
  const el = document.getElementById('editFlash');
  el.textContent=msg; el.className='flash show flash-'+type;
  setTimeout(()=>el.classList.remove('show'),4000);
}

// тФАтФА PAYMENTS
let allPayments = [];
let allPayMembers = [];

async function loadPayments() {
  const snap = await getDocs(query(collection(db,'payments'), orderBy('createdAt','desc')));
  allPayments = snap.docs.map(d=>({...d.data(), id:d.id}));
  renderPayments(allPayments);

  // Populate member select
  const sel = document.getElementById('pay-member');
  if (sel) {
    const mSnap = await getDocs(query(collection(db,'users'), where('status','==','approved')));
    allPayMembers = mSnap.docs.map(d=>({...d.data(), uid:d.id}));
    sel.innerHTML = '<option value="">-- рж╕ржжрж╕рзНржп ржмрзЗржЫрзЗ ржирж┐ржи --</option>';
    allPayMembers.forEach(m => {
      sel.innerHTML += `<option value="${m.uid}">${m.name} (${m.memberId||m.uid.slice(0,6)}) тАФ ${m.area||''}</option>`;
    });
  }
  renderPaySummary();
}

function renderPayments(list) {
  const tbody = document.getElementById('payTableBody');
  if (!tbody) return;
  if (list.length===0) { tbody.innerHTML='<tr><td colspan="7" style="text-align:center;padding:30px;color:rgba(255,255,255,.3)">ржХрзЛржирзЛ ржкрзЗржорзЗржирзНржЯ рж░рзЗржХрж░рзНржб ржирзЗржЗ</td></tr>'; return; }
  const total = list.reduce((s,p)=>s+parseFloat(p.amount||0),0);
  tbody.innerHTML = list.map(p=>`<tr>
    <td><div class="mem-name">${p.memberName||'-'}</div><div style="color:rgba(255,255,255,.4);font-size:11px">${p.memberId||''}</div></td>
    <td style="color:var(--sgold);font-weight:700;">рз│ ${p.amount}</td>
    <td>${p.month||''} ${p.year||''}</td>
    <td><span class="badge b-approved">${p.payType||'-'}</span></td>
    <td>${p.createdAt?.seconds?new Date(p.createdAt.seconds*1000).toLocaleDateString('bn-BD'):'-'}</td>
    <td style="color:rgba(255,255,255,.5);font-size:12px;">${p.note||'-'}</td>
    <td style="display:flex;gap:6px;">
      <button class="btn btn-r" onclick="deletePayment('${p.id}')">ЁЯЧС</button>
    </td>
  </tr>`).join('')
  + `<tr style="border-top:2px solid var(--b2)"><td colspan="1" style="color:var(--text2);font-weight:700;">ржорзЛржЯ:</td><td style="color:var(--sgold);font-weight:700;font-size:1.1rem;">рз│ ${total}</td><td colspan="5"></td></tr>`;
}

window.searchPayments = function(q) {
  const f = allPayments.filter(p =>
    p.memberName?.toLowerCase().includes(q.toLowerCase()) ||
    p.month?.includes(q) || (p.year+'').includes(q)
  );
  renderPayments(f);
};

window.savePayment = async function() {
  const uid = document.getElementById('pay-member').value;
  const amount = document.getElementById('pay-amount').value;
  const month = document.getElementById('pay-month').value;
  const year = document.getElementById('pay-year').value;
  const payType = document.getElementById('pay-type').value;
  const note = document.getElementById('pay-note').value.trim();
  const editId = document.getElementById('editPayId').value;

  if (!uid || !amount) { flash('payFlash','тЪая╕П рж╕ржжрж╕рзНржп ржУ ржкрж░рж┐ржорж╛ржг ржжрж┐ржиред','err'); return; }

  const member = allPayMembers.find(m=>m.uid===uid);
  const btn = document.getElementById('paySaveBtn');
  btn.disabled=true; btn.textContent='тП│ рж╕ржВрж░ржХрзНрж╖ржг рж╣ржЪрзНржЫрзЗ...';

  try {
    const data = {
      memberId: member?.memberId||uid.slice(0,8),
      memberName: member?.name||'-',
      memberArea: member?.area||'',
      memberUid: uid,
      amount: parseFloat(amount),
      month, year: parseInt(year), payType,
      note, addedBy: currentUserData?.name||'Admin',
      updatedAt: serverTimestamp()
    };
    if (editId) {
      await updateDoc(doc(db,'payments',editId), data);
      flash('payFlash','тЬЕ ржкрзЗржорзЗржирзНржЯ ржЖржкржбрзЗржЯ рж╣ржпрж╝рзЗржЫрзЗред');
    } else {
      data.createdAt = serverTimestamp();
      await addDoc(collection(db,'payments'), data);
      flash('payFlash','тЬЕ ржкрзЗржорзЗржирзНржЯ рж╕ржВрж░ржХрзНрж╖ржг рж╣ржпрж╝рзЗржЫрзЗред');
    }
    document.getElementById('editPayId').value='';
    document.getElementById('pay-member').value='';
    document.getElementById('pay-amount').value='';
    document.getElementById('pay-month').value='';
    document.getElementById('pay-note').value='';
    switchPayTab('list', document.querySelector('#s-payments .ptab'));
    loadPayments();
  } catch(e) { flash('payFlash','тЭМ рж╕ржорж╕рзНржпрж╛: '+e.message,'err'); }
  finally { btn.disabled=false; btn.textContent='ЁЯТ╛ рж╕ржВрж░ржХрзНрж╖ржг ржХрж░рзБржи'; }
};

window.deletePayment = async function(id) {
  if (!confirm('ржПржЗ ржкрзЗржорзЗржирзНржЯ рж░рзЗржХрж░рзНржб ржорзБржЫрзЗ ржлрзЗрж▓ржмрзЗржи?')) return;
  await deleteDoc(doc(db,'payments',id));
  flash('payFlash','ЁЯЧС рж░рзЗржХрж░рзНржб ржорзБржЫрзЗ ржлрзЗрж▓рж╛ рж╣ржпрж╝рзЗржЫрзЗред');
  loadPayments();
};

function renderPaySummary() {
  const el = document.getElementById('paySummaryContent');
  if (!el) return;
  // Group by member
  const byMember = {};
  allPayments.forEach(p => {
    if (!byMember[p.memberUid]) byMember[p.memberUid] = { name: p.memberName, id: p.memberId, total: 0, count: 0 };
    byMember[p.memberUid].total += parseFloat(p.amount||0);
    byMember[p.memberUid].count++;
  });
  const sorted = Object.values(byMember).sort((a,b)=>b.total-a.total);
  const grandTotal = sorted.reduce((s,m)=>s+m.total,0);

  el.innerHTML = `
  <div class="stat-grid" style="margin-bottom:20px;">
    <div class="stat-card gold"><div class="stat-ico">ЁЯТ░</div><div class="stat-num">рз│${grandTotal}</div><div class="stat-label">ржорзЛржЯ рж╕ржВржЧрзНрж░рж╣</div></div>
    <div class="stat-card green"><div class="stat-ico">ЁЯУЛ</div><div class="stat-num">${allPayments.length}</div><div class="stat-label">ржорзЛржЯ ржПржирзНржЯрзНрж░рж┐</div></div>
    <div class="stat-card blue"><div class="stat-ico">ЁЯСд</div><div class="stat-num">${sorted.length}</div><div class="stat-label">ржкрзНрж░ржжрж╛ржиржХрж╛рж░рзА рж╕ржжрж╕рзНржп</div></div>
  </div>
  <div class="table-wrap">
    <div class="table-head"><h3>ЁЯСд рж╕ржжрж╕рзНржп ржЕржирзБржпрж╛ржпрж╝рзА рж╕рж╛рж░рж╕ржВржХрзНрж╖рзЗржк</h3></div>
    <div style="overflow-x:auto"><table>
      <thead><tr><th>#</th><th>рж╕ржжрж╕рзНржп</th><th>ID</th><th>ржорзЛржЯ ржкрж░рж┐ржорж╛ржг</th><th>ржПржирзНржЯрзНрж░рж┐ рж╕ржВржЦрзНржпрж╛</th></tr></thead>
      <tbody>${sorted.map((m,i)=>`<tr>
        <td style="color:rgba(255,255,255,.4)">${i+1}</td>
        <td><div class="mem-name">${m.name}</div></td>
        <td style="color:rgba(255,255,255,.5)">${m.id||'-'}</td>
        <td style="color:var(--sgold);font-weight:700;">рз│ ${m.total}</td>
        <td>${m.count}</td>
      </tr>`).join('')}</tbody>
    </table></div>
  </div>`;
}

// тФАтФА REPORTS / DOWNLOAD
window.downloadMembersCSV = async function() {
  const snap = await getDocs(query(collection(db,'users'),where('status','==','approved')));
  const list = snap.docs.map(d=>d.data());
  const headers = ['ржирж╛ржо','рж╕ржжрж╕рзНржп ID','ржПрж▓рж╛ржХрж╛','ржлрзЛржи','ржкржжржмрж┐','рж░ржХрзНрждрзЗрж░ ржЧрзНрж░рзБржк','рж▓рж┐ржЩрзНржЧ','ржЬржирзНржо рждрж╛рж░рж┐ржЦ','ржЗржорзЗржЗрж▓','ржарж┐ржХрж╛ржирж╛'];
  const rows = list.map(m=>[m.name||'',m.memberId||'',m.area||'',m.phone||'',m.position||'',m.bloodGroup||'',m.gender||'',m.dob||'',m.email||'',m.address||'']);
  csvDownload([headers,...rows], 'рж╕ржжрж╕рзНржп-рждрж╛рж▓рж┐ржХрж╛');
};

window.downloadPaymentsCSV = async function() {
  const snap = await getDocs(query(collection(db,'payments'),orderBy('createdAt','desc')));
  const list = snap.docs.map(d=>d.data());
  const headers = ['рж╕ржжрж╕рзНржпрзЗрж░ ржирж╛ржо','рж╕ржжрж╕рзНржп ID','ржПрж▓рж╛ржХрж╛','ржкрж░рж┐ржорж╛ржг (рз│)','ржорж╛рж╕','ржмржЫрж░','ржзрж░ржи','ржирзЛржЯ','ржпрзЛржЧ ржХрж░рзЗржЫрзЗржи'];
  const rows = list.map(p=>[p.memberName||'',p.memberId||'',p.memberArea||'',p.amount||'',p.month||'',p.year||'',p.payType||'',p.note||'',p.addedBy||'']);
  csvDownload([headers,...rows], 'ржкрзЗржорзЗржирзНржЯ-рж░рж┐ржкрзЛрж░рзНржЯ');
};

window.downloadSummaryCSV = async function() {
  const snap = await getDocs(query(collection(db,'users'),where('status','==','approved')));
  const list = snap.docs.map(d=>d.data());
  // Group by area
  const byArea = {};
  list.forEach(m=>{ const a=m.area||'ржЕржирзНржпрж╛ржирзНржп'; byArea[a]=(byArea[a]||0)+1; });
  const headers = ['ржПрж▓рж╛ржХрж╛','рж╕ржжрж╕рзНржп рж╕ржВржЦрзНржпрж╛'];
  const rows = Object.entries(byArea).sort((a,b)=>b[1]-a[1]).map(([a,c])=>[a,c]);
  csvDownload([headers,...rows], 'ржПрж▓рж╛ржХрж╛-рж╕рж╛рж░рж╕ржВржХрзНрж╖рзЗржк');
};

function csvDownload(rows, filename) {
  const bom = '\uFEFF';
  const csv = bom + rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename + '_' + new Date().toISOString().slice(0,10) + '.csv';
  a.click();
}

window.printMembersList = async function() {
  const snap = await getDocs(query(collection(db,'users'),where('status','==','approved')));
  const list = snap.docs.map(d=>d.data());
  const win = window.open('','_blank');
  win.document.write(`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>рж╕ржжрж╕рзНржп рждрж╛рж▓рж┐ржХрж╛</title>
  <style>body{font-family:'Arial',sans-serif;padding:20px;direction:ltr}h1{text-align:center;color:#1b6b1b;margin-bottom:4px}p{text-align:center;color:#666;margin-bottom:20px;font-size:13px}table{width:100%;border-collapse:collapse;font-size:13px}th,td{border:1px solid #ddd;padding:8px 10px;text-align:left}th{background:#1b6b1b;color:#fff}tr:nth-child(even){background:#f5f5f5}@media print{button{display:none}}</style>
  </head><body>
  <h1>рж╕ржорж╛ржЬ ржХрж▓рзНржпрж╛ржг ржпрзБржм рж╕ржВржЧржаржи</h1><p>рж╕ржжрж╕рзНржп рждрж╛рж▓рж┐ржХрж╛ тАФ ржорзЛржЯ: ${list.length} ржЬржи тАФ рждрж╛рж░рж┐ржЦ: ${new Date().toLocaleDateString('bn-BD')}</p>
  <button onclick="window.print()" style="margin-bottom:14px;padding:8px 20px;background:#1b6b1b;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:14px">ЁЯЦия╕П ржкрзНрж░рж┐ржирзНржЯ ржХрж░рзБржи</button>
  <table><thead><tr><th>#</th><th>ржирж╛ржо</th><th>ID</th><th>ржПрж▓рж╛ржХрж╛</th><th>ржлрзЛржи</th><th>ржкржжржмрж┐</th><th>рж░ржХрзНржд</th></tr></thead>
  <tbody>${list.map((m,i)=>`<tr><td>${i+1}</td><td>${m.name||'-'}</td><td>${m.memberId||'-'}</td><td>${m.area||'-'}</td><td>${m.phone||'-'}</td><td>${m.position||'-'}</td><td>${m.bloodGroup||'-'}</td></tr>`).join('')}</tbody></table>
  </body></html>`);
  win.document.close();
};

// Also load payments when section is visited
const origGoSection = window.goSection;

// тФАтФА Helpers
function flash(id, msg, type='ok') {
  const el = document.getElementById(id);
  if (!el) return;
  el.textContent = msg;
  el.className = 'flash show flash-'+type;
  setTimeout(()=>el.classList.remove('show'),4000);
}
</script>

<script>
// тФАтФА SECTION NAVIGATION
const sections = ['dashboard','pending','members','addmember','admins','notices','gallery','stats','payments','reports'];
const sectionTitles = {
  dashboard:'ЁЯУК ржбрзНржпрж╛рж╢ржмрзЛрж░рзНржб', pending:'тП│ ржкрзЗржирзНржбрж┐ржВ ржЖржмрзЗржжржи', members:'ЁЯСе рж╕ржХрж▓ рж╕ржжрж╕рзНржп',
  addmember:'тЮХ рж╕ржжрж╕рзНржп ржпрзЛржЧ ржХрж░рзБржи', admins:'ЁЯФС Admin ржмрзНржпржмрж╕рзНржерж╛ржкржирж╛',
  notices:'ЁЯУв ржирзЛржЯрж┐рж╢', gallery:'ЁЯУ╖ ржЧрзНржпрж╛рж▓рж╛рж░рж┐', stats:'ЁЯУИ ржкрж░рж┐рж╕ржВржЦрзНржпрж╛ржи',
  payments:'ЁЯТ░ ржЪрж╛ржБржжрж╛ / ржкрзЗржорзЗржирзНржЯ', reports:'ЁЯУе рж░рж┐ржкрзЛрж░рзНржЯ ржбрж╛ржЙржирж▓рзЛржб'
};

function goSection(id) {
  sections.forEach(s=>{
    const el=document.getElementById('s-'+s); if(el) el.style.display=s===id?'block':'none';
  });
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  const navItems=document.querySelectorAll('.nav-item');
  navItems.forEach(n=>{if(n.getAttribute('onclick')?.includes("'"+id+"'")) n.classList.add('active');});
  document.getElementById('sectionTitle').textContent = sectionTitles[id]||id;
  if (id==='payments' && typeof loadPayments === 'function') loadPayments();
  closeSidebar();
}

function switchNoticeTab(tab, btn) {
  document.getElementById('noticeListPanel').style.display = tab==='list'?'block':'none';
  document.getElementById('noticeAddPanel').style.display = tab==='add'?'block':'none';
  document.querySelectorAll('#s-notices .ptab').forEach(b=>b.classList.remove('active'));
  if(btn) btn.classList.add('active');
}

function switchGalTab(tab, btn) {
  document.getElementById('galListPanel').style.display = tab==='list'?'block':'none';
  document.getElementById('galAddPanel').style.display = tab==='add'?'block':'none';
  document.querySelectorAll('#s-gallery .ptab').forEach(b=>b.classList.remove('active'));
  if(btn) btn.classList.add('active');
}

function switchPayTab(tab, btn) {
  document.getElementById('payListPanel').style.display = tab==='list'?'block':'none';
  document.getElementById('payAddPanel').style.display = tab==='add'?'block':'none';
  document.getElementById('paySummaryPanel').style.display = tab==='summary'?'block':'none';
  document.querySelectorAll('#s-payments .ptab').forEach(b=>b.classList.remove('active'));
  if(btn) btn.classList.add('active');
}

function openSidebar() {
  document.getElementById('sidebar').classList.add('open');
  document.getElementById('sidebarOverlay').classList.add('open');
}
function closeSidebar() {
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('sidebarOverlay').classList.remove('open');
}

// Clock
function updateClock() {
  const now = new Date();
  document.getElementById('currentTime').textContent = now.toLocaleTimeString('bn-BD');
}
setInterval(updateClock, 1000);
updateClock();
</script>

<script>
// тХРтХР ADD MEMBER BY ADMIN тАФ normal script (module ржПрж░ ржмрж╛ржЗрж░рзЗ) тХРтХР
const AM_CLOUDINARY_URL = 'https://api.cloudinary.com/v1_1/dasurbavl/image/upload';
const AM_UPLOAD_PRESET = 'somaj-kallyan-upload';
const AM_FIREBASE_URL = 'https://firestore.googleapis.com/v1/projects/somaj-kallyan/databases/(default)/documents/users';
const AM_API_KEY = 'AIzaSyDwzJgWcc4XPt4czcXpVFkHTniJFISpO7I';

function amPreviewPhoto(input) {
  if (!input.files[0]) return;
  const file = input.files[0];
  if (file.size > 5 * 1024 * 1024) { alert('ржЫржмрж┐ 5MB ржПрж░ ржмрзЗрж╢рж┐ рж╣ржмрзЗ ржирж╛ред'); input.value=''; return; }
  const reader = new FileReader();
  reader.onload = e => {
    document.getElementById('amPhotoPreview').src = e.target.result;
    document.getElementById('amPhotoPreview').style.display = 'block';
    document.getElementById('amPhotoPlaceholder').style.display = 'none';
  };
  reader.readAsDataURL(file);
}

async function amUploadPhoto(file) {
  return new Promise((resolve, reject) => {
    const fd = new FormData();
    fd.append('file', file);
    fd.append('upload_preset', AM_UPLOAD_PRESET);
    fd.append('folder', 'somaj-kallyan/members');
    const xhr = new XMLHttpRequest();
    xhr.open('POST', AM_CLOUDINARY_URL);
    const bar = document.getElementById('amUploadBar');
    const txt = document.getElementById('amUploadTxt');
    document.getElementById('amUploadProgress').style.display = 'block';
    xhr.upload.onprogress = e => {
      if (e.lengthComputable) {
        const pct = Math.round(e.loaded / e.total * 100);
        bar.style.width = pct + '%';
        txt.textContent = 'ржЖржкрж▓рзЛржб рж╣ржЪрзНржЫрзЗ... ' + pct + '%';
      }
    };
    xhr.onload = () => {
      if (xhr.status === 200) {
        txt.textContent = 'тЬЕ ржЫржмрж┐ ржЖржкрж▓рзЛржб рж╕ржлрж▓!';
        resolve(JSON.parse(xhr.responseText).secure_url);
      } else { document.getElementById('amUploadProgress').style.display='none'; reject(new Error('ржЖржкрж▓рзЛржб ржмрзНржпрж░рзНрже')); }
    };
    xhr.onerror = () => { document.getElementById('amUploadProgress').style.display='none'; reject(new Error('ржирзЗржЯржУржпрж╝рж╛рж░рзНржХ рж╕ржорж╕рзНржпрж╛')); };
    xhr.send(fd);
  });
}

async function saveAdminMember() {
  const name     = document.getElementById('am-name').value.trim();
  const phone    = document.getElementById('am-phone').value.trim();
  const area     = document.getElementById('am-area').value;
  const position = document.getElementById('am-position').value;
  const blood    = document.getElementById('am-blood').value;
  const gender   = document.getElementById('am-gender').value;
  const dob      = document.getElementById('am-dob').value;
  const email    = document.getElementById('am-email').value.trim();
  const address  = document.getElementById('am-address').value.trim();
  const photoFile = document.getElementById('amPhotoFile').files[0];

  if (!name) { amFlash('тЪая╕П ржирж╛ржо ржжрж┐ржиред', 'err'); return; }
  if (!area) { amFlash('тЪая╕П ржЧрзНрж░рж╛ржо/ржПрж▓рж╛ржХрж╛ ржмрзЗржЫрзЗ ржирж┐ржиред', 'err'); return; }
  if (!photoFile) { amFlash('тЪая╕П рж╕ржжрж╕рзНржпрзЗрж░ ржЫржмрж┐ ржЖржкрж▓рзЛржб ржХрж░рзБржиред', 'err'); return; }

  const btn = document.getElementById('amSaveBtn');
  btn.disabled = true; btn.textContent = 'тП│ рж╕ржВрж░ржХрзНрж╖ржг рж╣ржЪрзНржЫрзЗ...';

  try {
    // рзз. Cloudinary рждрзЗ ржЫржмрж┐ ржЖржкрж▓рзЛржб
    btn.textContent = 'ЁЯУ╕ ржЫржмрж┐ ржЖржкрж▓рзЛржб рж╣ржЪрзНржЫрзЗ...';
    const photoUrl = await amUploadPhoto(photoFile);

    // рзи. Firestore REST API ржжрж┐ржпрж╝рзЗ approved member рж╣рж┐рж╕рзЗржмрзЗ save
    btn.textContent = 'ЁЯТ╛ Firebase ржП рж╕ржВрж░ржХрзНрж╖ржг...';
    const now = new Date().toISOString();
    const year = new Date().getFullYear();
    // Random serial
    const serial = String(Math.floor(Math.random() * 900) + 100);
    const memberId = year + '-' + serial;

    const docData = {
      fields: {
        name:        { stringValue: name },
        phone:       { stringValue: phone || '' },
        area:        { stringValue: area },
        position:    { stringValue: position },
        bloodGroup:  { stringValue: blood || '' },
        gender:      { stringValue: gender || '' },
        dob:         { stringValue: dob || '' },
        email:       { stringValue: email || '' },
        address:     { stringValue: address || '' },
        photoUrl:    { stringValue: photoUrl },
        memberId:    { stringValue: memberId },
        role:        { stringValue: 'member' },
        status:      { stringValue: 'approved' },
        addedByAdmin:{ booleanValue: true },
      }
    };

    const res = await fetch(
      `https://firestore.googleapis.com/v1/projects/somaj-kallyan/databases/(default)/documents/users?key=${AM_API_KEY}`,
      { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(docData) }
    );

    if (!res.ok) throw new Error('Firebase save failed: ' + res.status);

    amFlash('тЬЕ рж╕ржжрж╕рзНржп рж╕ржлрж▓ржнрж╛ржмрзЗ ржпрзЛржЧ рж╣ржпрж╝рзЗржЫрзЗ! ID: ' + memberId, 'ok');
    resetAmForm();
    // Main Firebase functions reload ржХрж░рзЛ (ржпржжрж┐ ржерж╛ржХрзЗ)
    if (typeof loadDashboard === 'function') loadDashboard();
    if (typeof loadMembers === 'function') loadMembers();

  } catch(e) {
    amFlash('тЭМ рж╕ржорж╕рзНржпрж╛ рж╣ржпрж╝рзЗржЫрзЗ: ' + e.message, 'err');
  } finally {
    btn.disabled = false;
    btn.textContent = 'ЁЯТ╛ рж╕ржжрж╕рзНржп рж╕ржВрж░ржХрзНрж╖ржг ржХрж░рзБржи';
  }
}

function resetAmForm() {
  ['am-name','am-phone','am-email','am-address','am-dob'].forEach(id => {
    const el = document.getElementById(id); if(el) el.value='';
  });
  ['am-area','am-position','am-blood','am-gender'].forEach(id => {
    const el = document.getElementById(id); if(el) el.selectedIndex=0;
  });
  const f = document.getElementById('amPhotoFile'); if(f) f.value='';
  const prev = document.getElementById('amPhotoPreview');
  if(prev){ prev.style.display='none'; prev.src=''; }
  const ph = document.getElementById('amPhotoPlaceholder');
  if(ph) ph.style.display='block';
  const prog = document.getElementById('amUploadProgress');
  if(prog) prog.style.display='none';
  const bar = document.getElementById('amUploadBar');
  if(bar) bar.style.width='0%';
}

function amFlash(msg, type='ok') {
  const el = document.getElementById('amFlash');
  if (!el) return;
  el.textContent = msg;
  el.className = 'flash show flash-' + type;
  setTimeout(() => el.classList.remove('show'), 5000);
}
</script>

</body>
</html>